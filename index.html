<!DOCTYPE html>
<html lang="ja" class="h-full bg-neutral-50">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BUILD_TAG=PHASE-5-20240529 | Muscle Routine</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ: ç™½ãƒ»å¢¨ãƒ»æ·¡ã„é‡‘ */
    :root {
      --color-sumi-dark: #1A1A1A;
      --color-sumi-mid: #404040;
      --color-sumi-light: #737373;
      --color-gold: #D4AF37;
      --color-gold-light: #E8D4A0;
      --color-gold-pale: #F5EDD6;
      --color-white: #FFFFFF;
      --color-off-white: #FAFAFA;
    }
    
    html, body { height: 100%; }
    body { 
      overflow-x: hidden;
      letter-spacing: 0.01em;
      line-height: 1.6;
    }
    
    :focus-visible { 
      outline: 2px solid var(--color-gold); 
      outline-offset: 2px; 
    }
    
    ::-webkit-scrollbar { width: 0; height: 0; }
    
    .ios-card { 
      border-radius: 20px; 
      box-shadow: 0 4px 16px -4px rgba(26, 26, 26, 0.08);
      transition: all 0.2s ease;
    }
    
    .ios-card:hover {
      box-shadow: 0 6px 20px -4px rgba(26, 26, 26, 0.12);
    }
    
    .section-card { 
      border-radius: 16px; 
      box-shadow: 0 2px 12px -2px rgba(26, 26, 26, 0.06);
      border: 1px solid rgba(115, 115, 115, 0.08);
    }
    
    .gold-accent {
      background: linear-gradient(135deg, var(--color-gold-pale) 0%, var(--color-white) 100%);
    }
    
    .sumi-text { color: var(--color-sumi-dark); }
    .sumi-text-mid { color: var(--color-sumi-mid); }
    .sumi-text-light { color: var(--color-sumi-light); }
  </style>
</head>
<body class="h-full sumi-text transition-colors duration-300">
  <div id="error-banner" class="hidden fixed top-0 left-0 right-0 z-50 flex items-center gap-2 bg-red-600 text-white px-4 py-3 shadow-lg">
    <span class="font-semibold">ã‚¨ãƒ©ãƒ¼</span>
    <span id="error-message" class="text-sm min-w-0 truncate"></span>
    <button type="button" id="error-dismiss" class="ml-auto text-xs font-semibold bg-white/15 hover:bg-white/25 rounded-full px-3 py-1 focus-visible:ring-2 focus-visible:ring-white/70 focus:outline-none min-h-[36px]">é–‰ã˜ã‚‹</button>
  </div>

  <main class="h-full max-w-3xl mx-auto px-4 pb-16 pt-20 flex flex-col gap-8 bg-transparent">
    <header class="space-y-2">
      <h1 class="text-3xl font-light tracking-wide sumi-text" style="letter-spacing: 0.05em;">ç­‹ãƒˆãƒ¬è¨˜éŒ²</h1>
      <p class="text-sm sumi-text-light font-light">è‡ªåˆ†ã®å¤‰åŒ–ã‚’ç¾ã—ãè¨˜éŒ²ã™ã‚‹ãƒ„ãƒ¼ãƒ«</p>
    </header>

    <section data-route="#/dashboard" class="route-view hidden flex flex-col gap-6 bg-neutral-50"></section>
    <section data-route="#/today" class="route-view hidden flex flex-col gap-6 bg-violet-50"></section>
    <section data-route="#/exercise" class="route-view hidden flex flex-col gap-6 bg-orange-50"></section>
    <section data-route="#/set" class="route-view hidden flex flex-col gap-6 bg-orange-50"></section>
    <section data-route="#/history" class="route-view hidden flex flex-col gap-6 bg-amber-50"></section>
    <section data-route="#/settings" class="route-view hidden flex flex-col gap-6 bg-sky-50"></section>
  </main>

  <script>
    const state = {
      schemaVersion: 2,
      master: {
        parts: [
          { id: 'chest', label: 'èƒ¸' },
          { id: 'back', label: 'èƒŒä¸­' },
          { id: 'shoulder', label: 'è‚©' },
          { id: 'arm', label: 'è…•' },
          { id: 'leg', label: 'è„š' },
          { id: 'core', label: 'ä½“å¹¹' },
          { id: 'full', label: 'å…¨èº«' }
        ],
        exercises: {
          chest: ['ãƒ•ãƒ©ã‚¤', 'ãƒ—ãƒ¬ã‚¹', 'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', 'ãƒã‚§ã‚¹ãƒˆãƒ—ãƒ¬ã‚¹', 'ãƒ‡ã‚£ãƒƒãƒ—ã‚¹', 'ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—'],
          back: ['ãƒãƒ³ãƒ‹ãƒ³ã‚°', 'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', 'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³', 'ãƒ—ãƒ¼ãƒªãƒ¼ãƒ­ãƒ¼', 'ãƒ™ãƒ³ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼', 'ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°', 'ãƒ—ãƒ«ã‚ªãƒ¼ãƒãƒ¼'],
          shoulder: ['ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹', 'ãƒ•ãƒ­ãƒ³ãƒˆãƒ¬ã‚¤ã‚º', 'ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º', 'ãƒªã‚¢ãƒ‡ãƒ«ãƒˆ', 'ãƒªã‚¢ãƒ¬ã‚¤ã‚º', 'ãƒ•ã‚§ã‚¤ã‚¹ãƒ—ãƒ«', 'ã‚¢ãƒ¼ãƒãƒ«ãƒ‰ãƒ—ãƒ¬ã‚¹', 'ãƒŸãƒªã‚¿ãƒªãƒ¼ãƒ—ãƒ¬ã‚¹', 'ãƒ‘ãƒ¼ã‚·ãƒ£ãƒ«ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º'],
          arm: ['ã‚¢ãƒ¼ãƒ ã‚«ãƒ¼ãƒ«', 'ã‚¹ã‚«ãƒ«ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼', 'ãƒãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ«', 'ãƒ—ãƒ¬ã‚¹ãƒ€ã‚¦ãƒ³', 'ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãƒ—ãƒ¬ã‚¹', 'ã‚­ãƒƒã‚¯ãƒãƒƒã‚¯', 'ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒƒã‚·ãƒ¥', 'å¿—æ¾¤ã‚«ãƒ¼ãƒ«', 'ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ«', 'ãƒŠãƒ­ãƒ¼ãƒ—ãƒ¬ã‚¹', 'ãƒ—ãƒªãƒãƒ£ãƒ¼ã‚«ãƒ¼ãƒ«'],
          leg: ['ã‚«ãƒ¼ãƒ«', 'ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³', 'ãƒ—ãƒ¬ã‚¹', 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ã‚¤ãƒ³ãƒŠãƒ¼ã‚µã‚¤', 'ã‚¢ã‚¦ã‚¿ãƒ¼ã‚µã‚¤', 'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', 'ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³', 'ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ'],
          core: ['ã‚¯ãƒ©ãƒ³ãƒ', 'ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º', 'ãƒ™ãƒ³ãƒãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º'],
          full: []
        },
        gear: ['-', 'ã‚±ãƒ¼ãƒ–ãƒ«', 'ãƒ€ãƒ³ãƒ™ãƒ«', 'ãƒãƒ¼ãƒ™ãƒ«', 'ã‚¹ãƒŸã‚¹', 'ãƒã‚·ãƒ³', 'ãƒšãƒƒã‚¯ãƒã‚·ãƒ³', 'è‡ªé‡', 'ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'ã‚´ãƒ ãƒãƒ¥ãƒ¼ãƒ–', 'ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒãƒ¼'],
        attachments: ['-', 'ãƒã‚°(ãƒŠãƒ­ãƒ¼)', 'ãƒã‚°(ãƒ¯ã‚¤ãƒ‰)', 'ãƒã‚°(ãƒŸãƒ‰ãƒ«)', 'ãƒ­ãƒ¼ãƒ—', 'Vãƒãƒ¼', 'ã‚¤ãƒ¼ã‚¸ãƒ¼ãƒãƒ¼', 'ãƒãƒ³ãƒ‰', 'ãƒ¯ã‚¤ãƒ‰ãƒãƒ¼', 'ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ¼', 'ãƒ‘ãƒ©ãƒ¬ãƒ«ãƒãƒ¼'],
        angles: ['-', 'ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³', 'ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³', 'ãƒ•ãƒ©ãƒƒãƒˆ'],
        positions: ['-', 'ãƒ¯ã‚¤ãƒ‰', 'ãƒŠãƒ­ãƒ¼', 'ãƒœãƒƒã‚¯ã‚¹', 'ãƒªãƒãƒ¼ã‚¹']
      },
      customMaster: {
        exercises: {},  // { chest: ['ã‚«ã‚¹ã‚¿ãƒ ç¨®ç›®1', ...], ... }
        gear: [],
        attachments: [],
        angles: [],
        positions: []
      },
      history: [],
      day: {
        date: new Date().toISOString().slice(0, 10),
        memo: '',
        items: [
          {
            id: createId('item'),
            order: 1,
            mode: 'single',
            groupId: null,
            part: 'chest',
            exercise: 'ãƒãƒ¼ãƒ™ãƒ«ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹',
            gear: 'ãƒãƒ¼ãƒ™ãƒ«',
            attachment: '-',
            angle: 'ãƒ•ãƒ©ãƒƒãƒˆ',
            position: '-',
            timed: false,
            oneHand: false,
            sets: [
              createSet({ weight: 60, repsU: 10, repsA: 0, warmup: true, drop: false, round: null, ts: Date.now() - 7200000 }),
              createSet({ weight: 80, repsU: 8, repsA: 0, warmup: false, drop: false, round: null, ts: Date.now() - 7100000 }),
              createSet({ weight: 60, repsU: 12, repsA: 0, warmup: false, drop: true, round: null, ts: Date.now() - 7090000 })
            ]
          },
          ...createSampleSuperset()
        ]
      }
    };

    const uiState = {
      route: null,
      exerciseForm: createExerciseFormState(),
      currentItemId: null,
      setEditor: null,
      editingHistoryIndex: null
    };

    // ã‚»ãƒƒãƒˆç·¨é›†ä¸­ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç¨®ç›®æƒ…å ±ï¼ˆè‡ªå‹•ä¿å­˜ç”¨ï¼‰
    let activeEditSession = null;

    function createId(prefix) {
      return `${prefix}-${Math.random().toString(36).slice(2, 11)}`;
    }

    function createSet({ weight = null, repsU = null, repsA = null, seconds = null, warmup = false, drop = false, round = null, ts = Date.now() }) {
      return { id: createId('set'), weight, repsU, repsA, seconds, warmup, drop, round, ts };
    }

    function createSampleSuperset() {
      const groupId = createGroupId();
      const now = Date.now();
      const baseTs = now - 3600000;
      const bench = {
        id: createId('item'),
        order: 2,
        mode: 'superset',
        groupId,
        part: 'chest',
        exercise: 'ãƒ€ãƒ³ãƒ™ãƒ«ãƒ•ãƒ©ã‚¤',
        gear: 'ãƒ€ãƒ³ãƒ™ãƒ«',
        attachment: '-',
        angle: 'ãƒ•ãƒ©ãƒƒãƒˆ',
        position: '-',
        timed: false,
        oneHand: false,
        sets: [
          createSet({ weight: 20, repsU: 12, repsA: 0, warmup: false, drop: false, round: 0, ts: baseTs }),
          createSet({ weight: 14, repsU: 12, repsA: 0, warmup: false, drop: true, round: 0, ts: baseTs + 1000 })
        ]
      };
      const pull = {
        id: createId('item'),
        order: 2.01,
        mode: 'superset',
        groupId,
        part: 'back',
        exercise: 'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³',
        gear: 'ãƒã‚·ãƒ³',
        attachment: 'ãƒ¯ã‚¤ãƒ‰ãƒãƒ¼',
        angle: '-',
        position: '-',
        timed: false,
        oneHand: false,
        sets: [
          createSet({ weight: 55, repsU: 10, repsA: 0, warmup: false, drop: false, round: 0, ts: baseTs })
        ]
      };
      return [bench, pull];
    }

    function createGroupId() {
      return `grp_${Math.random().toString(36).slice(2, 8)}`;
    }

    function createExerciseFormState() {
      // LocalStorageã‹ã‚‰å‰å›ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
      const saved = loadLastExerciseSettings();
      if (saved) {
        // å‰ã®ã‚»ãƒƒãƒˆã®éƒ¨ä½ã‚’å¼•ãç¶™ã
        const lastItem = state.day.items[state.day.items.length - 1];
        if (lastItem && lastItem.part) {
          saved.selectedParts = [lastItem.part];
        }
        return saved;
      }
      
      // å‰ã®ã‚»ãƒƒãƒˆã®éƒ¨ä½ã‚’å¼•ãç¶™ã
      const lastItem = state.day.items[state.day.items.length - 1];
      const selectedParts = lastItem && lastItem.part ? [lastItem.part] : [];
      
      return {
        superset: false,
        cards: [createExerciseCardState('A')],
        selectedParts: selectedParts
      };
    }
    
    function saveLastExerciseSettings(formState) {
      try {
        localStorage.setItem('lastExerciseSettings', JSON.stringify(formState));
      } catch (e) {
        console.error('Failed to save exercise settings:', e);
      }
    }
    
    function loadLastExerciseSettings() {
      try {
        const saved = localStorage.getItem('lastExerciseSettings');
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.error('Failed to load exercise settings:', e);
      }
      return null;
    }
    
    function clearLastExerciseSettings() {
      try {
        localStorage.removeItem('lastExerciseSettings');
      } catch (e) {
        console.error('Failed to clear exercise settings:', e);
      }
    }

    function createExerciseCardState(label) {
      const firstPart = state.master.parts[0]?.id ?? '';
      const firstExercise = (state.master.exercises[firstPart] || [])[0] || '';
      return {
        key: createId('card'),
        label,
        part: firstPart,
        exercise: firstExercise,
        gear: '-',
        attachment: '-',
        angle: '-',
        position: '-',
        timed: false,
        oneHand: false,
        dropset: false
      };
    }

    function sortForDisplay(list) {
      return [...list].sort((a, b) => {
        if (a === '-') return -1;
        if (b === '-') return 1;
        return a.localeCompare(b, 'ja');
      });
    }

    function showError(message) {
      const banner = document.getElementById('error-banner');
      const text = document.getElementById('error-message');
      text.textContent = message;
      banner.classList.remove('hidden');
    }

    window.onerror = function(message, source, lineno, colno) {
      showError(`${message} (${lineno}:${colno})`);
    };

    window.onunhandledrejection = function(event) {
      showError(event.reason ? event.reason.toString() : 'Unhandled rejection');
    };

    window.__forceError = function() {
      setTimeout(() => {
        throw new Error('å¼·åˆ¶ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ');
      }, 0);
      Promise.reject(new Error('å¼·åˆ¶ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ'));
    };

    document.getElementById('error-dismiss').addEventListener('click', () => {
      document.getElementById('error-banner').classList.add('hidden');
    });

    function navigate(hash) {
      if (window.location.hash === hash) {
        handleNavigation(hash);
      } else {
        window.location.hash = hash;
      }
    }

    function handleNavigation(hash) {
      const valid = ['#/dashboard', '#/today', '#/exercise', '#/set', '#/history', '#/settings'];
      const next = valid.includes(hash) ? hash : '#/dashboard';
      uiState.route = next;
      
      // bodyã®èƒŒæ™¯è‰²ã‚’ãƒ«ãƒ¼ãƒˆã«å¿œã˜ã¦å¤‰æ›´
      const bgColors = {
        '#/dashboard': 'bg-neutral-50',
        '#/today': 'bg-violet-50',
        '#/exercise': 'bg-orange-50',
        '#/set': 'bg-orange-50',
        '#/history': 'bg-amber-50',
        '#/settings': 'bg-sky-50'
      };
      
      const body = document.body;
      // æ—¢å­˜ã®èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      Object.values(bgColors).forEach(cls => body.classList.remove(cls));
      // æ–°ã—ã„èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      body.classList.add(bgColors[next]);
      
      document.querySelectorAll('.route-view').forEach(section => {
        section.classList.toggle('hidden', section.getAttribute('data-route') !== next);
      });
      render();
    }

    window.addEventListener('hashchange', () => handleNavigation(window.location.hash));

    function render() {
      if (uiState.route === '#/dashboard') renderDashboard();
      if (uiState.route === '#/today') renderToday();
      if (uiState.route === '#/exercise') renderExercise();
      if (uiState.route === '#/set') renderSet();
      if (uiState.route === '#/history') renderHistory();
      if (uiState.route === '#/settings') renderSettings();
    }

    function renderDashboard() {
      const container = document.querySelector('[data-route="#/dashboard"]');
      container.innerHTML = '';

      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      const navContainer = document.createElement('div');
      navContainer.className = 'space-y-3';
      
      // ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒœã‚¿ãƒ³ï¼ˆå…¨å¹…ï¼‰
      const todayButton = document.createElement('button');
      todayButton.type = 'button';
      todayButton.className = 'ios-card bg-white w-full px-6 py-4 text-base font-light transition active:scale-[0.99] min-h-[44px] sumi-text hover:gold-accent border border-neutral-100';
      todayButton.innerHTML = `
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">ğŸ“</span>
          <span>ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</span>
        </div>
      `;
      todayButton.addEventListener('click', () => navigate('#/today'));
      navContainer.appendChild(todayButton);
      
      // å±¥æ­´ã¨è¨­å®šãƒœã‚¿ãƒ³ï¼ˆåŠåˆ†ãšã¤ï¼‰
      const bottomRow = document.createElement('div');
      bottomRow.className = 'grid grid-cols-2 gap-3';
      
      const historyButton = document.createElement('button');
      historyButton.type = 'button';
      historyButton.className = 'ios-card bg-white w-full px-6 py-4 text-base font-light transition active:scale-[0.99] min-h-[44px] sumi-text hover:gold-accent border border-neutral-100';
      historyButton.innerHTML = `
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">ğŸ“–</span>
          <span>å±¥æ­´</span>
        </div>
      `;
      historyButton.addEventListener('click', () => navigate('#/history'));
      bottomRow.appendChild(historyButton);
      
      const settingsButton = document.createElement('button');
      settingsButton.type = 'button';
      settingsButton.className = 'ios-card bg-white w-full px-6 py-4 text-base font-light transition active:scale-[0.99] min-h-[44px] sumi-text hover:gold-accent border border-neutral-100';
      settingsButton.innerHTML = `
        <div class="flex flex-col items-center gap-2">
          <span class="text-2xl">âš™ï¸</span>
          <span>è¨­å®š</span>
        </div>
      `;
      settingsButton.addEventListener('click', () => navigate('#/settings'));
      bottomRow.appendChild(settingsButton);
      
      navContainer.appendChild(bottomRow);
      container.appendChild(navContainer);

      // çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰
      const stats = computeDashboardStats();
      const statsCard = document.createElement('section');
      statsCard.className = 'section-card bg-white p-4 space-y-3';
      statsCard.innerHTML = `
        <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">çµ±è¨ˆæƒ…å ±</h2>
        <div class="grid grid-cols-3 gap-3 text-center">
          <div class="section-card gold-accent py-4 px-3 min-h-[44px] flex flex-col justify-center">
            <p class="text-xs sumi-text-light font-light mb-1">ä»Šé€±</p>
            <p class="text-3xl font-light sumi-text">${stats.thisWeek}</p>
            <p class="text-xs sumi-text-light font-light mt-1">å›</p>
          </div>
          <div class="section-card bg-neutral-50 py-4 px-3 min-h-[44px] flex flex-col justify-center">
            <p class="text-xs sumi-text-light font-light mb-1">ç·æ—¥æ•°</p>
            <p class="text-3xl font-light sumi-text">${stats.totalDays}</p>
            <p class="text-xs sumi-text-light font-light mt-1">æ—¥</p>
          </div>
          <div class="section-card bg-neutral-50 py-4 px-3 min-h-[44px] flex flex-col justify-center">
            <p class="text-xs sumi-text-light font-light mb-1">æœ€çµ‚æ—¥</p>
            <p class="text-lg font-light sumi-text">${stats.lastDate}</p>
          </div>
        </div>
      `;
      container.appendChild(statsCard);

      // ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå±¥æ­´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      if (state.history.length > 0) {
        // éƒ¨ä½åˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é »åº¦ã‚°ãƒ©ãƒ•
        const bodyPartChartSection = document.createElement('section');
        bodyPartChartSection.className = 'section-card bg-white p-4 space-y-3';
        bodyPartChartSection.innerHTML = `
          <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">éƒ¨ä½åˆ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é »åº¦</h2>
          <div style="height: 280px; position: relative;">
            <canvas id="bodyPartChart"></canvas>
          </div>
        `;
        container.appendChild(bodyPartChartSection);
        
        // é€±é–“ç·ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¨ç§»ã‚°ãƒ©ãƒ•
        const weeklyVolumeSection = document.createElement('section');
        weeklyVolumeSection.className = 'section-card bg-white p-4 space-y-3';
        weeklyVolumeSection.innerHTML = `
          <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">é€±é–“ç·ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¨ç§»</h2>
          <div style="height: 240px; position: relative;">
            <canvas id="weeklyVolumeChart"></canvas>
          </div>
        `;
        container.appendChild(weeklyVolumeSection);
        
        // ç¨®ç›®åˆ¥é€²æ—ã‚°ãƒ©ãƒ•
        const exerciseNames = getAllExerciseNames();
        if (exerciseNames.length > 0) {
          const progressChartSection = document.createElement('section');
          progressChartSection.className = 'section-card bg-white p-4 space-y-3';
          
          const selectContainer = document.createElement('div');
          selectContainer.className = 'flex items-center justify-between gap-3';
          selectContainer.innerHTML = `
            <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">ç¨®ç›®åˆ¥é€²æ—</h2>
            <select id="exerciseSelect" class="text-sm sumi-text bg-neutral-50 border border-neutral-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-violet-300">
              ${exerciseNames.map(name => `<option value="${name}">${name}</option>`).join('')}
            </select>
          `;
          progressChartSection.appendChild(selectContainer);
          
          const chartContainer = document.createElement('div');
          chartContainer.style.height = '240px';
          chartContainer.style.position = 'relative';
          chartContainer.innerHTML = '<canvas id="exerciseProgressChart"></canvas>';
          progressChartSection.appendChild(chartContainer);
          
          container.appendChild(progressChartSection);
          
          // åˆæœŸè¡¨ç¤º
          setTimeout(() => {
            renderExerciseProgressChart('exerciseProgressChart', exerciseNames[0]);
          }, 100);
          
          // ç¨®ç›®å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          document.getElementById('exerciseSelect')?.addEventListener('change', (e) => {
            renderExerciseProgressChart('exerciseProgressChart', e.target.value);
          });
          
          // ç¨®ç›®åˆ¥ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¨ç§»ã‚°ãƒ©ãƒ•
          const volumeChartSection = document.createElement('section');
          volumeChartSection.className = 'section-card bg-white p-4 space-y-3';
          
          const volumeSelectContainer = document.createElement('div');
          volumeSelectContainer.className = 'flex items-center justify-between gap-3';
          volumeSelectContainer.innerHTML = `
            <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">ç¨®ç›®åˆ¥ãƒœãƒªãƒ¥ãƒ¼ãƒ æ¨ç§»</h2>
            <select id="exerciseVolumeSelect" class="text-sm sumi-text bg-neutral-50 border border-neutral-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-violet-300">
              ${exerciseNames.map(name => `<option value="${name}">${name}</option>`).join('')}
            </select>
          `;
          volumeChartSection.appendChild(volumeSelectContainer);
          
          const volumeChartContainer = document.createElement('div');
          volumeChartContainer.style.height = '240px';
          volumeChartContainer.style.position = 'relative';
          volumeChartContainer.innerHTML = '<canvas id="exerciseVolumeChart"></canvas>';
          volumeChartSection.appendChild(volumeChartContainer);
          
          container.appendChild(volumeChartSection);
          
          // åˆæœŸè¡¨ç¤º
          setTimeout(() => {
            renderExerciseVolumeChart('exerciseVolumeChart', exerciseNames[0]);
          }, 100);
          
          // ç¨®ç›®å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          document.getElementById('exerciseVolumeSelect')?.addEventListener('change', (e) => {
            renderExerciseVolumeChart('exerciseVolumeChart', e.target.value);
          });
        }
        
        // éƒ¨ä½åˆ¥ãƒãƒ£ãƒ¼ãƒˆã‚’æç”»
        setTimeout(() => {
          renderBodyPartChart('bodyPartChart');
          renderWeeklyVolumeChart('weeklyVolumeChart');
        }, 100);
      }

      // æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¦‚è¦
      if (state.history.length > 0) {
        const recentSection = document.createElement('section');
        recentSection.className = 'section-card bg-white p-4 space-y-3';
        
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between';
        header.innerHTML = `
          <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</h2>
          <button type="button" class="text-sm sumi-text-light hover:sumi-text transition font-light" id="view-all-history">ã™ã¹ã¦è¦‹ã‚‹ â†’</button>
        `;
        recentSection.appendChild(header);
        
        const recentWorkouts = state.history.slice(0, 3);
        recentWorkouts.forEach((workout, index) => {
          const workoutCard = createRecentWorkoutCard(workout);
          recentSection.appendChild(workoutCard);
          if (index < recentWorkouts.length - 1) {
            const divider = document.createElement('div');
            divider.className = 'border-t border-neutral-100';
            recentSection.appendChild(divider);
          }
        });
        
        container.appendChild(recentSection);
        
        document.getElementById('view-all-history')?.addEventListener('click', () => navigate('#/history'));
      } else {
        // å±¥æ­´ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const emptyCard = document.createElement('section');
        emptyCard.className = 'section-card bg-white p-6 text-center';
        emptyCard.innerHTML = `
          <p class="text-base sumi-text-light font-light mb-4">ã¾ã ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <button type="button" class="ios-card gold-accent px-6 py-3 text-base font-light sumi-text transition active:scale-[0.99] min-h-[44px]" id="start-first-workout">æœ€åˆã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å§‹ã‚ã‚‹</button>
        `;
        container.appendChild(emptyCard);
        
        document.getElementById('start-first-workout')?.addEventListener('click', () => navigate('#/today'));
      }
    }

    function computeDashboardStats() {
      // ä»Šé€±ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å›æ•°ã‚’è¨ˆç®—
      const now = new Date();
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - now.getDay()); // æ—¥æ›œæ—¥ã‚’é€±ã®å§‹ã¾ã‚Šã¨ã™ã‚‹
      startOfWeek.setHours(0, 0, 0, 0);
      
      const thisWeekCount = state.history.filter(workout => {
        const workoutDate = new Date(workout.date);
        return workoutDate >= startOfWeek;
      }).length;
      
      // ç·ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥æ•°
      const totalDays = state.history.length;
      
      // æœ€å¾Œã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ—¥ä»˜
      let lastDate = '-';
      if (state.history.length > 0) {
        const lastWorkout = state.history[0];
        const date = new Date(lastWorkout.date);
        lastDate = `${date.getMonth() + 1}/${date.getDate()}`;
      }
      
      return {
        thisWeek: thisWeekCount,
        totalDays,
        lastDate
      };
    }

    // ã‚°ãƒ©ãƒ•ç”¨ã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿å‡¦ç†é–¢æ•°
    function computeExerciseProgressData(exerciseName) {
      // ç‰¹å®šã®ç¨®ç›®ã®é‡é‡æ¨ç§»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const data = [];
      
      // å±¥æ­´ã‚’å¤ã„é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedHistory = [...state.history].reverse();
      
      sortedHistory.forEach(workout => {
        workout.items.forEach(item => {
          const fullExerciseName = buildFullExerciseName(item);
          if (fullExerciseName === exerciseName) {
            // ã“ã®ç¨®ç›®ã®æœ€å¤§é‡é‡ã‚’å–å¾—
            const maxWeight = Math.max(...item.sets.map(set => parseFloat(set.weight) || 0));
            if (maxWeight > 0) {
              const date = new Date(workout.date);
              data.push({
                date: `${date.getMonth() + 1}/${date.getDate()}`,
                weight: maxWeight
              });
            }
          }
        });
      });
      
      return data;
    }
    
    function computeBodyPartFrequency() {
      // éƒ¨ä½åˆ¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é »åº¦ã‚’é›†è¨ˆ
      const frequency = {};
      
      state.history.forEach(workout => {
        workout.items.forEach(item => {
          const part = state.master.parts.find(p => p.id === item.part);
          const partLabel = part ? part.label : item.part;
          frequency[partLabel] = (frequency[partLabel] || 0) + 1;
        });
      });
      
      return frequency;
    }
    
    function getAllExerciseNames() {
      // å…¨ã¦ã®ç¨®ç›®åã‚’å–å¾—ï¼ˆé‡è¤‡ãªã—ï¼‰
      const exerciseNames = new Set();
      
      state.history.forEach(workout => {
        workout.items.forEach(item => {
          const fullName = buildFullExerciseName(item);
          exerciseNames.add(fullName);
        });
      });
      
      return Array.from(exerciseNames).sort();
    }
    
    function buildFullExerciseName(item) {
      // ç¨®ç›®ã®å®Œå…¨ãªåå‰ã‚’æ§‹ç¯‰
      let name = '';
      
      // éƒ¨ä½
      const part = state.master.parts.find(p => p.id === item.part);
      if (part) name += part.label + ' - ';
      
      // ç¨®ç›®
      name += item.exercise;
      
      return name;
    }

    // ãƒœãƒªãƒ¥ãƒ¼ãƒ è¨ˆç®—é–¢æ•°
    function computeExerciseVolume(item) {
      return item.sets.reduce((total, set) => {
        if (set.warmup) return total; // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã¯é™¤å¤–
        const weight = parseFloat(set.weight) || 0;
        const reps = parseInt(set.reps) || 0;
        return total + (weight * reps);
      }, 0);
    }
    
    function computeSessionVolume(workout) {
      return workout.items.reduce((total, item) => {
        return total + computeExerciseVolume(item);
      }, 0);
    }
    
    function getWeekKey(date) {
      const d = new Date(date);
      const startOfWeek = new Date(d);
      startOfWeek.setDate(d.getDate() - d.getDay());
      startOfWeek.setHours(0, 0, 0, 0);
      
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      
      const startMonth = startOfWeek.getMonth() + 1;
      const startDay = startOfWeek.getDate();
      const endMonth = endOfWeek.getMonth() + 1;
      const endDay = endOfWeek.getDate();
      
      return `${startMonth}/${startDay}-${endMonth}/${endDay}`;
    }
    
    function computeWeeklyVolume() {
      const weeklyData = {};
      
      state.history.forEach(workout => {
        const weekKey = getWeekKey(workout.date);
        
        if (!weeklyData[weekKey]) {
          weeklyData[weekKey] = 0;
        }
        
        weeklyData[weekKey] += computeSessionVolume(workout);
      });
      
      return weeklyData;
    }
    
    function computeExerciseVolumeProgress(exerciseName) {
      const data = [];
      const sortedHistory = [...state.history].reverse();
      
      sortedHistory.forEach(workout => {
        workout.items.forEach(item => {
          const fullName = buildFullExerciseName(item);
          if (fullName === exerciseName) {
            const volume = computeExerciseVolume(item);
            if (volume > 0) {
              const date = new Date(workout.date);
              data.push({
                date: `${date.getMonth() + 1}/${date.getDate()}`,
                volume: volume
              });
            }
          }
        });
      });
      
      return data;
    }

    // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°
    function renderExerciseProgressChart(canvasId, exerciseName) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const data = computeExerciseProgressData(exerciseName);
      if (data.length === 0) return;
      
      const ctx = canvas.getContext('2d');
      
      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
      if (canvas.chart) {
        canvas.chart.destroy();
      }
      
      canvas.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.date),
          datasets: [{
            label: 'é‡é‡ (kg)',
            data: data.map(d => d.weight),
            borderColor: 'rgb(139, 92, 246)',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(26, 26, 26, 0.9)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              borderColor: 'rgb(212, 175, 55)',
              borderWidth: 1,
              padding: 12,
              displayColors: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(115, 115, 115, 0.1)'
              },
              ticks: {
                color: '#737373',
                font: {
                  size: 11
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#737373',
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }
    
    function renderBodyPartChart(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const frequency = computeBodyPartFrequency();
      const labels = Object.keys(frequency);
      const data = Object.values(frequency);
      
      if (labels.length === 0) return;
      
      const ctx = canvas.getContext('2d');
      
      // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
      if (canvas.chart) {
        canvas.chart.destroy();
      }
      
      const colors = [
        'rgb(139, 92, 246)',   // ç´«
        'rgb(212, 175, 55)',   // é‡‘
        'rgb(251, 146, 60)',   // ã‚ªãƒ¬ãƒ³ã‚¸
        'rgb(59, 130, 246)',   // é’
        'rgb(236, 72, 153)',   // ãƒ”ãƒ³ã‚¯
        'rgb(34, 197, 94)',    // ç·‘
        'rgb(168, 85, 247)'    // æ·±ç´«
      ];
      
      canvas.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#FFFFFF'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#404040',
                font: {
                  size: 12
                },
                padding: 12,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 26, 26, 0.9)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              borderColor: 'rgb(212, 175, 55)',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value}å› (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    function renderWeeklyVolumeChart(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      if (canvas.chart) {
        canvas.chart.destroy();
      }
      
      const weeklyData = computeWeeklyVolume();
      const labels = Object.keys(weeklyData);
      const data = Object.values(weeklyData);
      
      if (labels.length === 0) {
        return;
      }
      
      canvas.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'é€±é–“ç·ãƒœãƒªãƒ¥ãƒ¼ãƒ  (kg)',
            data: data,
            backgroundColor: 'rgba(139, 92, 246, 0.8)',
            borderColor: 'rgb(139, 92, 246)',
            borderWidth: 2,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#404040',
                font: {
                  size: 12,
                  weight: 'bold'
                },
                padding: 12,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 26, 26, 0.9)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              borderColor: 'rgb(212, 175, 55)',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' kg';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#404040',
                font: {
                  size: 11
                },
                callback: function(value) {
                  return value.toLocaleString() + ' kg';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                color: '#404040',
                font: {
                  size: 11
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
    
    function renderExerciseVolumeChart(canvasId, exerciseName) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      if (canvas.chart) {
        canvas.chart.destroy();
      }
      
      const progressData = computeExerciseVolumeProgress(exerciseName);
      
      if (progressData.length === 0) {
        return;
      }
      
      const labels = progressData.map(d => d.date);
      const data = progressData.map(d => d.volume);
      
      canvas.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ãƒœãƒªãƒ¥ãƒ¼ãƒ  (kg)',
            data: data,
            borderColor: 'rgb(212, 175, 55)',
            backgroundColor: 'rgba(212, 175, 55, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: 'rgb(212, 175, 55)',
            pointBorderColor: '#FFFFFF',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: '#404040',
                font: {
                  size: 12,
                  weight: 'bold'
                },
                padding: 12,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(26, 26, 26, 0.9)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              borderColor: 'rgb(212, 175, 55)',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' kg';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#404040',
                font: {
                  size: 11
                },
                callback: function(value) {
                  return value.toLocaleString() + ' kg';
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              ticks: {
                color: '#404040',
                font: {
                  size: 11
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function createRecentWorkoutCard(workout) {
      const card = document.createElement('div');
      card.className = 'py-3 space-y-2';
      
      const date = new Date(workout.date);
      const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
      
      // ç¨®ç›®æ•°ã¨ã‚»ãƒƒãƒˆæ•°ã‚’è¨ˆç®—
      const exerciseCount = workout.items.length;
      const totalSets = workout.items.reduce((sum, item) => sum + item.sets.length, 0);
      
      // éƒ¨ä½ã‚’é›†è¨ˆ
      const parts = [...new Set(workout.items.map(item => {
        const part = state.master.parts.find(p => p.id === item.part);
        return part ? part.label : item.part;
      }))].join('ã€');
      
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <p class="text-sm font-light sumi-text">${dateStr}</p>
          <p class="text-xs sumi-text-light font-light">${exerciseCount}ç¨®ç›® Â· ${totalSets}ã‚»ãƒƒãƒˆ</p>
        </div>
        <p class="text-xs sumi-text-light font-light">${parts}</p>
      `;
      
      return card;
    }

    function computeTodayStats() {
      const singles = state.day.items
        .filter(item => item.mode === 'single')
        .flatMap(item => item.sets)
        .filter(set => !set.warmup)
        .length;
      const roundMap = new Map();
      state.day.items
        .filter(item => item.mode === 'superset' && item.groupId)
        .forEach(item => {
          if (!roundMap.has(item.groupId)) roundMap.set(item.groupId, new Map());
          const groupRounds = roundMap.get(item.groupId);
          item.sets.forEach(set => {
            if (set.round === null || set.round === undefined) return;
            if (!groupRounds.has(set.round)) groupRounds.set(set.round, { hasWorking: false });
            if (!set.warmup) {
              groupRounds.get(set.round).hasWorking = true;
            }
          });
        });
      let supersetRounds = 0;
      roundMap.forEach(group => {
        group.forEach(entry => {
          if (entry.hasWorking) supersetRounds += 1;
        });
      });
      return {
        soloSets: singles,
        supersetRounds,
        workSets: singles + supersetRounds
      };
    }

    function renderToday() {
      const container = document.querySelector('[data-route="#/today"]');
      container.innerHTML = '';

      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼‰
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-3';
      const title = document.createElement('h1');
      title.className = 'text-lg font-light sumi-text';
      const isEditing = uiState.editingHistoryIndex !== null;
      title.textContent = isEditing ? 'å±¥æ­´ã‚’ç·¨é›†' : 'ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°';
      header.appendChild(title);
      const homeButton = document.createElement('button');
      homeButton.type = 'button';
      homeButton.className = 'flex items-center gap-1 text-sm font-light sumi-text-light hover:sumi-text transition min-h-[44px] px-3';
      homeButton.innerHTML = 'â† ãƒ›ãƒ¼ãƒ ';
      homeButton.addEventListener('click', () => navigate('#/dashboard'));
      header.appendChild(homeButton);
      container.appendChild(header);

      const statsSection = document.createElement('section');
      statsSection.className = 'section-card bg-white p-4 space-y-2';
      const summary = computeTodayStats();
      statsSection.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-base font-light sumi-text" style="letter-spacing: 0.03em;">ä»Šæ—¥ã®æ¦‚è¦</h2>
          <span class="text-xs font-light sumi-text-light">ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—é™¤å¤–</span>
        </div>
        <div class="grid grid-cols-3 gap-2 text-center">
          <div class="ios-card py-3 min-h-[44px] flex flex-col justify-center border" style="background-color: rgba(245, 237, 214, 0.15); border-color: rgba(212, 175, 55, 0.2); color: var(--color-gold);">
            <p class="text-xs font-light">ä½œæ¥­ã‚»ãƒƒãƒˆ</p>
            <p class="text-2xl font-light">${summary.workSets}</p>
          </div>
          <div class="ios-card py-3 min-h-[44px] flex flex-col justify-center border" style="background-color: rgba(245, 237, 214, 0.15); border-color: rgba(212, 175, 55, 0.2); color: var(--color-gold);">
            <p class="text-xs font-light">SSãƒ©ã‚¦ãƒ³ãƒ‰</p>
            <p class="text-2xl font-light">${summary.supersetRounds}</p>
          </div>
          <div class="ios-card py-3 min-h-[44px] flex flex-col justify-center border" style="background-color: rgba(245, 237, 214, 0.15); border-color: rgba(212, 175, 55, 0.2); color: var(--color-gold);">
            <p class="text-xs font-light">å˜ç‹¬ã‚»ãƒƒãƒˆ</p>
            <p class="text-2xl font-light">${summary.soloSets}</p>
          </div>
        </div>
      `;
      container.appendChild(statsSection);

      // ãƒ¡ãƒ¢å…¥åŠ›æ¬„
      const memoSection = document.createElement('div');
      memoSection.className = 'section-card bg-white p-4 space-y-2';
      const memoLabel = document.createElement('label');
      memoLabel.className = 'text-xs font-light sumi-text-light';
      memoLabel.textContent = 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¡ãƒ¢';
      const memoTextarea = document.createElement('textarea');
      memoTextarea.className = 'w-full p-3 text-sm sumi-text font-light border rounded-lg focus:outline-none focus:ring-2 focus:ring-gold/30 transition';
      memoTextarea.style.cssText = 'border-color: rgba(115, 115, 115, 0.2); background-color: rgba(245, 237, 214, 0.05); min-height: 80px; resize: vertical;';
      memoTextarea.placeholder = 'ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ãƒ¡ãƒ¢ã‚’è¨˜éŒ²...';
      memoTextarea.value = state.day.memo || '';
      memoTextarea.addEventListener('input', (e) => {
        state.day.memo = e.target.value;
        autoSaveDraft(); // è‡ªå‹•ä¿å­˜
      });
      memoSection.appendChild(memoLabel);
      memoSection.appendChild(memoTextarea);
      container.appendChild(memoSection);

      const actionRow = document.createElement('div');
      actionRow.className = 'flex items-center gap-3';
      const addButton = document.createElement('button');
      addButton.type = 'button';
      addButton.className = 'ios-card px-6 py-3 font-light text-base min-h-[44px] border transition';
      addButton.style.cssText = 'background-color: var(--color-gold); color: white; border-color: var(--color-gold-dark); letter-spacing: 0.05em; flex: 2;';
      addButton.textContent = 'ï¼‹ ç¨®ç›®è¿½åŠ ';
      addButton.addEventListener('click', () => {
        uiState.exerciseForm = createExerciseFormState();
        navigate('#/exercise');
      });
      actionRow.appendChild(addButton);
      
      const completeButton = document.createElement('button');
      completeButton.type = 'button';
      completeButton.className = 'ios-card px-6 py-3 font-light text-base min-h-[44px] border transition';
      completeButton.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em; flex: 1;';
      completeButton.textContent = isEditing ? 'ä¿å­˜' : 'å®Œäº†';
      completeButton.addEventListener('click', () => {
        const message = isEditing ? 'å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ' : 'ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ';
        if (confirm(message)) {
          completeWorkout();
        }
      });
      actionRow.appendChild(completeButton);
      container.appendChild(actionRow);

      const list = document.createElement('div');
      list.className = 'space-y-3';
      const sortedItems = [...state.day.items].sort((a, b) => a.order - b.order);
      const processedGroups = new Set();
      sortedItems.forEach(item => {
        if (item.mode === 'superset') {
          if (!item.groupId || processedGroups.has(item.groupId)) return;
          const groupItems = sortedItems.filter(candidate => candidate.groupId === item.groupId);
          processedGroups.add(item.groupId);
          list.appendChild(buildSupersetCard(groupItems));
        } else {
          list.appendChild(buildSingleCard(item));
        }
      });
      container.appendChild(list);
    }

    function buildSingleCard(item) {
      const card = document.createElement('article');
      card.className = 'section-card bg-white p-4 space-y-2';
      const partLabel = state.master.parts.find(p => p.id === item.part)?.label ?? '';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šç¨®ç›®åã¨éƒ¨ä½
      const header = document.createElement('div');
      header.className = 'space-y-1';
      header.innerHTML = `
        <p class="text-base font-light sumi-text" style="letter-spacing: 0.02em;">${item.exercise}</p>
        <p class="text-xs font-light sumi-text-light">${partLabel}</p>
      `;
      card.appendChild(header);
      
      // å™¨å…·ãƒ»è§’åº¦ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³
      const details = document.createElement('div');
      details.className = 'text-xs font-light sumi-text-light';
      details.textContent = [item.gear, item.angle, item.position].map(val => val && val !== '-' ? val : 'â€•').join(' / ');
      card.appendChild(details);
      if (item.attachment && item.attachment !== '-') {
        const att = document.createElement('p');
        att.className = 'text-[11px] font-light sumi-text-light';
        att.textContent = `ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ: ${item.attachment}`;
        card.appendChild(att);
      }

      const badgeArea = document.createElement('div');
      badgeArea.className = 'flex flex-col gap-2';
      groupSetsForDisplay(item.sets).forEach(group => {
        const row = document.createElement('div');
        row.className = 'flex flex-col gap-1';
        const badgeRow = document.createElement('div');
        badgeRow.className = 'flex items-start gap-2';
        badgeRow.appendChild(createSetBadge(group.base, item));
        if (group.drops.length > 0) {
          const dropList = document.createElement('div');
          dropList.className = 'pl-6 flex flex-wrap gap-2';
          group.drops.forEach(drop => dropList.appendChild(createSetBadge(drop, item, true)));
          badgeRow.appendChild(dropList);
        }
        row.appendChild(badgeRow);
        if (group.base.memo) {
          const memoDiv = document.createElement('div');
          memoDiv.className = 'pl-1 text-[10px] font-light sumi-text-light';
          memoDiv.textContent = `ãƒ¡ãƒ¢: ${group.base.memo}`;
          row.appendChild(memoDiv);
        }
        badgeArea.appendChild(row);
      });
      card.appendChild(badgeArea);

      const controls = document.createElement('div');
      controls.className = 'flex justify-end';
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'px-4 py-2 rounded-full text-sm font-light min-h-[44px] border transition';
      editBtn.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em;';
      editBtn.textContent = 'ç·¨é›†';
      editBtn.addEventListener('click', () => {
        uiState.currentItemId = item.id;
        prepareSetEditor(item.id);
        navigate('#/set');
      });
      controls.appendChild(editBtn);
      card.appendChild(controls);
      return card;
    }

    function buildSupersetCard(groupItems) {
      const sorted = [...groupItems].sort((a, b) => a.order - b.order);
      const labels = ['A', 'B', 'C'];
      const title = `(SS) ${sorted.map(item => item.exercise).join(' + ')}`;
      const card = document.createElement('article');
      card.className = 'section-card bg-white p-4 space-y-2';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šç¨®ç›®åã¨éƒ¨ä½
      const header = document.createElement('div');
      header.className = 'space-y-1';
      header.innerHTML = `
        <p class="text-base font-light sumi-text" style="letter-spacing: 0.02em;">${title}</p>
        <p class="text-xs font-light sumi-text-light">${sorted.map((item, index) => `${labels[index]}. ${state.master.parts.find(p => p.id === item.part)?.label ?? ''}`).join(' / ')}</p>
      `;
      card.appendChild(header);
      
      // å™¨å…·ãƒ»è§’åº¦ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ³
      const details = document.createElement('div');
      details.className = 'text-xs font-light sumi-text-light';
      details.textContent = sorted.map(item => [item.gear, item.angle, item.position].map(val => val && val !== '-' ? val : 'â€•').join(' / ')).join(' ï½œ ');
      card.appendChild(details);

      const rounds = buildSupersetRounds(sorted);
      if (rounds.length > 0) {
        const roundList = document.createElement('div');
        roundList.className = 'flex flex-col gap-2';
        rounds.forEach(round => {
          const row = document.createElement('div');
          row.className = 'flex flex-col gap-1';
          const badgeRow = document.createElement('div');
          badgeRow.className = 'flex flex-wrap gap-2 items-start';
          round.entries.forEach(entry => badgeRow.appendChild(entry));
          row.appendChild(badgeRow);
          if (round.drops.length > 0) {
            const dropRow = document.createElement('div');
            dropRow.className = 'pl-6 flex flex-wrap gap-2';
            round.drops.forEach(drop => dropRow.appendChild(drop));
            row.appendChild(dropRow);
          }
          roundList.appendChild(row);
        });
        card.appendChild(roundList);
      }

      const soloArea = document.createElement('div');
      const soloChips = [];
      sorted.forEach((item, index) => {
        const solos = groupSetsForDisplay(item.sets.filter(set => set.round == null));
        solos.forEach(group => {
          const row = document.createElement('div');
          row.className = 'flex items-start gap-2';
          const chip = createSetBadge(group.base, item);
          chip.textContent = `${labels[index]}: ${chip.textContent}`;
          row.appendChild(chip);
          if (group.drops.length > 0) {
            const dropList = document.createElement('div');
            dropList.className = 'pl-6 flex flex-wrap gap-2';
            group.drops.forEach(drop => dropList.appendChild(createSetBadge(drop, item, true)));
            row.appendChild(dropList);
          }
          soloChips.push(row);
        });
      });
      if (soloChips.length > 0) {
        const soloArea = document.createElement('div');
        soloArea.className = 'space-y-2 pt-2 border-t border-neutral-100';
        const soloList = document.createElement('div');
        soloList.className = 'space-y-2';
        soloChips.forEach(row => soloList.appendChild(row));
        soloArea.appendChild(soloList);
        card.appendChild(soloArea);
      }

      const controls = document.createElement('div');
      controls.className = 'flex justify-end gap-3 pt-1';
      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'px-4 py-2 rounded-full text-sm font-light min-h-[44px] border transition';
      editBtn.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em;';
      editBtn.textContent = 'ç·¨é›†';
      editBtn.addEventListener('click', () => {
        uiState.currentItemId = sorted[0].id;
        prepareSetEditor(sorted[0].id);
        navigate('#/set');
      });
      controls.appendChild(editBtn);
      card.appendChild(controls);
      return card;
    }

    function buildSupersetRounds(groupItems) {
      const map = new Map();
      const labels = ['A', 'B', 'C'];
      groupItems.forEach((item, index) => {
        let currentBase = null;
        item.sets
          .filter(set => set.round !== null && set.round !== undefined)
          .sort((a, b) => a.ts - b.ts)
          .forEach(set => {
            if (!map.has(set.round)) {
              map.set(set.round, { entries: new Map(), drops: [] });
            }
            const slot = map.get(set.round);
            if (!set.drop) {
              currentBase = { item, set };
              slot.entries.set(labels[index], { item, set, drops: [] });
            } else if (currentBase && slot.entries.has(labels[index])) {
              slot.entries.get(labels[index]).drops.push({ item, set });
            } else {
              slot.drops.push(createSetBadge(set, item, true));
            }
          });
      });
      const rows = [];
      [...map.keys()].sort((a, b) => a - b).forEach(round => {
        const entry = map.get(round);
        const displayEntries = [];
        const dropBadges = [...entry.drops];
        groupItems.forEach((item, index) => {
          const label = labels[index];
          const data = entry.entries.get(label);
          if (data) {
            const chip = createSetBadge(data.set, data.item);
            chip.textContent = `${label}: ${chip.textContent}`;
            displayEntries.push(chip);
            data.drops.forEach(drop => {
              dropBadges.push(createSetBadge(drop.set, drop.item, true));
            });
          }
        });
        if (displayEntries.length > 0) {
          rows.push({ entries: displayEntries, drops: dropBadges });
        }
      });
      return rows;
    }

    function groupSetsForDisplay(sets) {
      const rows = [];
      let current = null;
      sets.forEach(set => {
        if (!set.drop) {
          current = { base: set, drops: [] };
          rows.push(current);
        } else if (current) {
          current.drops.push(set);
        } else {
          rows.push({ base: set, drops: [] });
        }
      });
      return rows;
    }

    function createSetBadge(set, item, isDrop = false) {
      const badge = document.createElement('span');
      const baseClasses = 'inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold min-h-[32px] truncate';
      const color = set.warmup ? 'bg-slate-200 text-slate-600' : 'bg-orange-100 text-orange-700';
      badge.className = `${baseClasses} ${isDrop ? 'border border-orange-200 bg-orange-50 text-orange-600' : color}`;
      badge.textContent = formatSetValue(set, item.timed);
      return badge;
    }

    function formatSetValue(set, timed) {
      if (timed) {
        return `${set.seconds ?? '-'}ç§’`;
      }
      const weight = set.weight != null ? `${set.weight}kg` : '-kg';
      const reps = set.repsU != null ? `${set.repsU}` : '-';
      const assist = set.repsA != null && set.repsA > 0 ? ` +${set.repsA}` : '';
      return `${weight}Ã—${reps}${assist}`;
    }

    function renderExercise() {
      const container = document.querySelector('[data-route="#/exercise"]');
      container.innerHTML = '';

      const form = document.createElement('form');
      form.className = 'section-card bg-white p-6 space-y-6';
      form.innerHTML = `
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-light sumi-text" style="letter-spacing: 0.05em;">ç¨®ç›®å…¥åŠ›</h2>
          <button type="button" id="exerciseBack" class="text-sm font-light px-3 py-2 min-h-[44px] transition" style="color: var(--color-gold);">â† æˆ»ã‚‹</button>
        </div>
        <div class="-mx-6 px-6 overflow-x-auto">
          <div id="partFilterButtons" class="flex gap-2 pb-2"></div>
        </div>
        <div class="flex items-center justify-between gap-3 rounded-2xl px-4 py-3 text-sm gold-accent border" style="border-color: rgba(212, 175, 55, 0.15);">
          <div class="flex items-center gap-3 sumi-text-mid">
            <input type="checkbox" id="supersetToggle" class="w-5 h-5 rounded" style="color: var(--color-gold);" ${uiState.exerciseForm.superset ? 'checked' : ''}>
            <label for="supersetToggle" class="font-light">ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒƒãƒˆã«ã™ã‚‹</label>
          </div>
          <button type="button" id="resetForm" class="text-xs sumi-text-light hover:sumi-text font-light px-2 py-1 transition">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <div id="exercisePreview" class="hidden rounded-xl px-4 py-3 text-sm border" style="background-color: rgba(245, 237, 214, 0.3); border-color: rgba(212, 175, 55, 0.2);">
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 mt-0.5 flex-shrink-0" style="color: var(--color-gold);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
              <div class="font-light sumi-text mb-1" style="letter-spacing: 0.02em;">å…¥åŠ›ä¸­ã®ç¨®ç›®</div>
              <div id="exercisePreviewText" class="sumi-text-mid font-light"></div>
            </div>
          </div>
        </div>
        <div id="exerciseCards" class="flex flex-col gap-4"></div>
        <div class="flex justify-between items-center">
          <button type="submit" class="ios-card text-white px-6 py-3 font-light min-h-[44px] transition" style="background-color: var(--color-gold); letter-spacing: 0.05em;">æ±ºå®š</button>
        </div>
      `;
      container.appendChild(form);

      const cardsContainer = form.querySelector('#exerciseCards');
      renderExerciseCards(cardsContainer);
      
      // éƒ¨ä½é¸æŠãƒœã‚¿ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      renderPartFilterButtons(form);

      // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      form.querySelector('#resetForm').addEventListener('click', () => {
        clearLastExerciseSettings();
        uiState.exerciseForm = {
          superset: false,
          cards: [createExerciseCardState('A')]
        };
        renderExercise();
      });
      
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–¢æ•°
      function updateExercisePreview() {
        const preview = form.querySelector('#exercisePreview');
        const previewText = form.querySelector('#exercisePreviewText');
        const cards = uiState.exerciseForm.cards;
        
        if (cards.length === 0) {
          preview.classList.add('hidden');
          return;
        }
        
        const descriptions = cards.map((card, index) => {
          const partLabel = state.master.parts.find(p => p.id === card.part)?.label || card.part;
          const details = [card.exercise, card.gear !== '-' ? card.gear : null, card.attachment !== '-' ? card.attachment : null, card.angle !== '-' ? card.angle : null, card.position !== '-' ? card.position : null].filter(Boolean).join(' / ');
          const prefix = uiState.exerciseForm.superset ? `${['A', 'B', 'C'][index]}: ` : '';
          return `${prefix}${partLabel} - ${details}`;
        });
        
        previewText.innerHTML = descriptions.join('<br>');
        preview.classList.remove('hidden');
        
        // LocalStorageã«ä¿å­˜
        saveLastExerciseSettings(uiState.exerciseForm);
      }

      form.addEventListener('change', event => {
        if (event.target.id === 'supersetToggle') {
          uiState.exerciseForm.superset = event.target.checked;
          if (uiState.exerciseForm.superset && uiState.exerciseForm.cards.length < 2) {
            uiState.exerciseForm.cards = [createExerciseCardState('A'), createExerciseCardState('B')];
          }
          if (!uiState.exerciseForm.superset) {
            uiState.exerciseForm.cards = [createExerciseCardState('A')];
          }
          renderExercise();
        }
        updateExercisePreview();
      });
      
      // åˆå›ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      updateExercisePreview();

      form.addEventListener('submit', event => {
        event.preventDefault();
        const newItems = buildItemsFromExerciseForm();
        const baseOrder = Math.max(0, ...state.day.items.map(item => item.order)) + 1;
        newItems.forEach((item, index) => {
          item.order = item.mode === 'superset' ? baseOrder + index * 0.01 : baseOrder;
          state.day.items.push(item);
        });
        state.day.items.sort((a, b) => a.order - b.order);
        const firstId = newItems[0]?.id;
        if (firstId) {
          uiState.currentItemId = firstId;
          prepareSetEditor(firstId, true);
          navigate('#/set');
        } else {
          navigate('#/today');
        }
      });

      form.querySelector('#exerciseBack').addEventListener('click', () => navigate('#/today'));
    }
    
    function renderPartFilterButtons(form) {
      const container = form.querySelector('#partFilterButtons');
      container.innerHTML = '';
      
      // é¸æŠä¸­ã®éƒ¨ä½ã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
      if (!uiState.exerciseForm.selectedParts) {
        uiState.exerciseForm.selectedParts = [];
      }
      
      state.master.parts.forEach(part => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'px-4 py-2 rounded-full text-sm font-light min-h-[40px] border transition whitespace-nowrap';
        
        const isSelected = uiState.exerciseForm.selectedParts.includes(part.id);
        if (isSelected) {
          button.style.cssText = 'background-color: var(--color-gold); color: white; border-color: var(--color-gold-dark); letter-spacing: 0.05em;';
        } else {
          button.style.cssText = 'background-color: white; color: var(--color-sumi); border-color: rgba(115, 115, 115, 0.2); letter-spacing: 0.05em;';
        }
        
        button.textContent = part.label;
        button.addEventListener('click', () => {
          togglePartFilter(part.id);
          renderPartFilterButtons(form);
          
          // éƒ¨ä½ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°
          if (uiState.exerciseForm.selectedParts.length === 1) {
            // éƒ¨ä½ãŒ1ã¤ã ã‘é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®éƒ¨ä½ã‚’ã‚«ãƒ¼ãƒ‰ã«è¨­å®š
            uiState.exerciseForm.cards.forEach(card => {
              card.part = uiState.exerciseForm.selectedParts[0];
            });
          }
          
          // ç¨®ç›®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
          const cardsContainer = form.querySelector('#exerciseCards');
          renderExerciseCards(cardsContainer);
        });
        
        container.appendChild(button);
      });
    }
    
    function togglePartFilter(partId) {
      if (!uiState.exerciseForm.selectedParts) {
        uiState.exerciseForm.selectedParts = [];
      }
      
      const index = uiState.exerciseForm.selectedParts.indexOf(partId);
      if (index > -1) {
        uiState.exerciseForm.selectedParts.splice(index, 1);
      } else {
        uiState.exerciseForm.selectedParts.push(partId);
      }
    }

    function renderExerciseCards(container) {
      container.innerHTML = '';
      uiState.exerciseForm.cards.forEach((card, index) => {
        const cardEl = document.createElement('section');
        cardEl.className = 'bg-white rounded-2xl p-4 space-y-3 border border-neutral-200/40 shadow-sm';
        const label = uiState.exerciseForm.superset ? ['A', 'B', 'C'][index] : '';
        const title = uiState.exerciseForm.superset ? `${label} ç¨®ç›®` : 'ç¨®ç›®è¨­å®š';
        cardEl.innerHTML = `
          <div class="flex items-center justify-between mb-1">
            <h3 class="text-base font-light sumi-text" style="letter-spacing: 0.02em;">${title}</h3>
            ${uiState.exerciseForm.superset && uiState.exerciseForm.cards.length > 2 && index === uiState.exerciseForm.cards.length - 1
              ? '<button type="button" class="text-xs sumi-text-light hover:sumi-text font-light transition" data-remove="true">å‰Šé™¤</button>'
              : ''}
          </div>
          
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="space-y-2 pb-2 border-b border-neutral-200/30">
            <div class="flex items-center gap-1.5">
              <div class="w-0.5 h-3 rounded-full" style="background-color: var(--color-gold);"></div>
              <h4 class="text-xs font-light sumi-text-mid" style="letter-spacing: 0.05em;">åŸºæœ¬æƒ…å ±</h4>
            </div>
            <div class="flex flex-col gap-2">
              <label class="flex flex-col gap-1">
                <span class="text-xs font-light sumi-text-mid flex items-center gap-0.5">
                  ç¨®ç›®<span style="color: var(--color-gold);">*</span>
                </span>
                <select class="w-full rounded-lg border border-neutral-200 px-2 py-1.5 text-sm min-h-[40px] sumi-text bg-white transition" style="border-color: rgba(115, 115, 115, 0.2);" data-field="exercise"></select>
              </label>
            </div>
          </div>
          
          <!-- å™¨å…·è¨­å®š -->
          <div class="space-y-2 py-2 border-b border-neutral-200/30">
            <div class="flex items-center gap-1.5">
              <div class="w-0.5 h-3 rounded-full" style="background-color: var(--color-gold-light);"></div>
              <h4 class="text-xs font-light sumi-text-mid" style="letter-spacing: 0.05em;">å™¨å…·</h4>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex flex-col gap-1">
                <span class="text-xs font-light sumi-text-mid">
                  å™¨å…· <span class="sumi-text-light text-[10px]">(ä»»æ„)</span>
                </span>
                <select class="w-full rounded-lg border border-neutral-200 px-2 py-1.5 text-sm min-h-[40px] sumi-text bg-white transition" style="border-color: rgba(115, 115, 115, 0.2);" data-field="gear"></select>
              </label>
              <label class="flex flex-col gap-1" data-attachment-field>
                <span class="text-xs font-light sumi-text-mid">
                  ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ <span class="sumi-text-light text-[10px]">(ä»»æ„)</span>
                </span>
                <select class="w-full rounded-lg border border-neutral-200 px-2 py-1.5 text-sm min-h-[40px] sumi-text bg-white transition" style="border-color: rgba(115, 115, 115, 0.2);" data-field="attachment"></select>
              </label>
            </div>
            <div class="text-[10px] sumi-text-light pl-0.5 font-light" data-attachment-hint>ã‚±ãƒ¼ãƒ–ãƒ«/ãƒã‚·ãƒ³æ™‚ã«è¨­å®š</div>
          </div>
          
          <!-- è©³ç´°è¨­å®š -->
          <div class="space-y-2 pt-2">
            <div class="flex items-center gap-1.5">
              <div class="w-0.5 h-3 rounded-full" style="background-color: var(--color-gold-pale);"></div>
              <h4 class="text-xs font-light sumi-text-mid" style="letter-spacing: 0.05em;">è©³ç´°</h4>
            </div>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex flex-col gap-1">
                <span class="text-xs font-light sumi-text-mid">
                  è§’åº¦ <span class="sumi-text-light text-[10px]">(ä»»æ„)</span>
                </span>
                <select class="w-full rounded-lg border border-neutral-200 px-2 py-1.5 text-sm min-h-[40px] sumi-text bg-white transition" style="border-color: rgba(115, 115, 115, 0.2);" data-field="angle"></select>
              </label>
              <label class="flex flex-col gap-1">
                <span class="text-xs font-light sumi-text-mid">
                  ãƒã‚¸ã‚·ãƒ§ãƒ³ <span class="sumi-text-light text-[10px]">(ä»»æ„)</span>
                </span>
                <select class="w-full rounded-lg border border-neutral-200 px-2 py-1.5 text-sm min-h-[40px] sumi-text bg-white transition" style="border-color: rgba(115, 115, 115, 0.2);" data-field="position"></select>
              </label>
            </div>
            <div class="flex flex-wrap gap-2 text-xs pt-1">
              <label class="flex items-center gap-1.5 rounded-lg px-3 py-1.5 border cursor-pointer transition" style="border-color: rgba(115, 115, 115, 0.15); background-color: rgba(245, 237, 214, 0.1);">
                <input type="checkbox" class="w-3.5 h-3.5 rounded focus:ring-1" style="color: var(--color-gold);" data-field="timed" ${card.timed ? 'checked' : ''}>
                <span class="font-light sumi-text">ç§’æ•°è¨˜éŒ²</span>
              </label>
              <label class="flex items-center gap-1.5 rounded-lg px-3 py-1.5 border cursor-pointer transition" style="border-color: rgba(115, 115, 115, 0.15); background-color: rgba(245, 237, 214, 0.1);">
                <input type="checkbox" class="w-3.5 h-3.5 rounded focus:ring-1" style="color: var(--color-gold);" data-field="oneHand" ${card.oneHand ? 'checked' : ''}>
                <span class="font-light sumi-text">ãƒ¯ãƒ³ãƒãƒ³ãƒ‰</span>
              </label>
              <label class="flex items-center gap-1.5 rounded-lg px-3 py-1.5 border cursor-pointer transition" style="border-color: rgba(115, 115, 115, 0.15); background-color: rgba(245, 237, 214, 0.1);">
                <input type="checkbox" class="w-3.5 h-3.5 rounded focus:ring-1" style="color: var(--color-gold);" data-field="dropset" ${card.dropset ? 'checked' : ''}>
                <span class="font-light sumi-text">ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ</span>
              </label>
            </div>
          </div>
        `;
        container.appendChild(cardEl);

        const exerciseSelect = cardEl.querySelector('[data-field="exercise"]');
        const selects = [
          { element: cardEl.querySelector('[data-field="gear"]'), field: 'gear', options: sortForDisplay(getAllGear()).map(value => ({ value, label: value })), allowAdd: true, addType: 'å™¨å…·' },
          { element: cardEl.querySelector('[data-field="attachment"]'), field: 'attachment', options: sortForDisplay(getAllAttachments()).map(value => ({ value, label: value })), allowAdd: true, addType: 'ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ' },
          { element: cardEl.querySelector('[data-field="angle"]'), field: 'angle', options: sortForDisplay(getAllAngles()).map(value => ({ value, label: value })), allowAdd: true, addType: 'è§’åº¦' },
          { element: cardEl.querySelector('[data-field="position"]'), field: 'position', options: sortForDisplay(getAllPositions()).map(value => ({ value, label: value })), allowAdd: true, addType: 'ãƒã‚¸ã‚·ãƒ§ãƒ³' }
        ];
        updateExerciseOptions(exerciseSelect, card);
        selects.forEach(select => populateSelect(select.element, select.options, card[select.field], select.allowAdd, select.addType));

        // ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ–‡è„ˆä¾å­˜è¡¨ç¤º
        const gearSelect = cardEl.querySelector('[data-field="gear"]');
        const attachmentField = cardEl.querySelector('[data-attachment-field]');
        const attachmentHint = cardEl.querySelector('[data-attachment-hint]');
        
        function updateAttachmentHighlight() {
          const gear = gearSelect.value;
          const needsAttachment = gear === 'ã‚±ãƒ¼ãƒ–ãƒ«' || gear === 'ãƒã‚·ãƒ³';
          if (needsAttachment) {
            attachmentField.classList.add('ring-2', 'ring-amber-200', 'bg-amber-50/30');
            attachmentHint.classList.remove('text-slate-400');
            attachmentHint.classList.add('text-amber-600', 'font-medium');
          } else {
            attachmentField.classList.remove('ring-2', 'ring-amber-200', 'bg-amber-50/30');
            attachmentHint.classList.remove('text-amber-600', 'font-medium');
            attachmentHint.classList.add('text-slate-400');
          }
        }
        
        updateAttachmentHighlight();

        cardEl.querySelectorAll('select, input[type="checkbox"]').forEach(field => {
          field.addEventListener('change', event => {
            const target = event.target;
            const fieldName = target.getAttribute('data-field');
            if (!fieldName) return;
            
            // æ–°è¦è¿½åŠ å‡¦ç†
            if (target.value === '__ADD_NEW__') {
              let name = null;
              let addFunction = null;
              let typeName = '';
              
              if (fieldName === 'exercise') {
                typeName = 'ç¨®ç›®';
                showCustomModal(`æ–°ã—ã„${typeName}ã‚’è¿½åŠ `, `${typeName}åã‚’å…¥åŠ›`, (name) => {
                  if (name && name.trim()) {
                    if (addCustomExercise(card.part, name.trim())) {
                      card.exercise = name.trim();
                      updateExerciseOptions(exerciseSelect, card);
                    } else {
                      target.value = card.exercise || '';
                    }
                  } else {
                    target.value = card.exercise || '';
                  }
                });
                return;
              } else if (fieldName === 'gear') {
                typeName = 'å™¨å…·';
                addFunction = addCustomGear;
              } else if (fieldName === 'attachment') {
                typeName = 'ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ';
                addFunction = addCustomAttachment;
              } else if (fieldName === 'angle') {
                typeName = 'è§’åº¦';
                addFunction = addCustomAngle;
              } else if (fieldName === 'position') {
                typeName = 'ãƒã‚¸ã‚·ãƒ§ãƒ³';
                addFunction = addCustomPosition;
              }
              
              if (addFunction) {
                showCustomModal(`æ–°ã—ã„${typeName}ã‚’è¿½åŠ `, `${typeName}åã‚’å…¥åŠ›`, (name) => {
                  if (name && name.trim()) {
                  if (addFunction(name.trim())) {
                    card[fieldName] = name.trim();
                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
                    const select = selects.find(s => s.field === fieldName);
                    if (select) {
                      let newOptions;
                      if (fieldName === 'gear') newOptions = sortForDisplay(getAllGear()).map(value => ({ value, label: value }));
                      else if (fieldName === 'attachment') newOptions = sortForDisplay(getAllAttachments()).map(value => ({ value, label: value }));
                      else if (fieldName === 'angle') newOptions = sortForDisplay(getAllAngles()).map(value => ({ value, label: value }));
                      else if (fieldName === 'position') newOptions = sortForDisplay(getAllPositions()).map(value => ({ value, label: value }));
                      populateSelect(target, newOptions, name.trim(), select.allowAdd, select.addType);
                    }
                  } else {
                    target.value = card[fieldName] || '-';
                  }
                } else {
                  target.value = card[fieldName] || '-';
                }
                });
                return;
              }
            }
            
            // é€šå¸¸ã®å¤‰æ›´å‡¦ç†
            if (fieldName === 'part') {
              card.part = target.value;
              updateExerciseOptions(exerciseSelect, card);
            } else if (fieldName === 'exercise') {
              card.exercise = target.value;
            } else if (fieldName === 'gear') {
              card.gear = target.value;
              updateAttachmentHighlight();
            } else if (fieldName === 'timed' || fieldName === 'oneHand' || fieldName === 'dropset') {
              card[fieldName] = target.checked;
            } else {
              card[fieldName] = target.value;
            }
          });
        });

        if (uiState.exerciseForm.superset && uiState.exerciseForm.cards.length > 2 && index === uiState.exerciseForm.cards.length - 1) {
          cardEl.querySelector('[data-remove="true"]').addEventListener('click', () => {
            uiState.exerciseForm.cards.splice(index, 1);
            renderExercise();
          });
        }
      });

      if (uiState.exerciseForm.superset && uiState.exerciseForm.cards.length < 3) {
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'w-full text-sm text-indigo-500 font-semibold px-4 py-3 bg-white rounded-2xl border border-dashed border-indigo-200 min-h-[44px]';
        addBtn.textContent = 'ï¼‹ ã‚«ãƒ¼ãƒ‰è¿½åŠ ';
        addBtn.addEventListener('click', () => {
          const label = ['A', 'B', 'C'][uiState.exerciseForm.cards.length] || 'C';
          uiState.exerciseForm.cards.push(createExerciseCardState(label));
          renderExercise();
        });
        container.appendChild(addBtn);
      }
    }

    function populateSelect(select, options, selected, allowAdd = false, addType = null) {
      select.innerHTML = '';
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label;
        if (option.value === selected) opt.selected = true;
        select.appendChild(opt);
      });
      
      // æ–°è¦è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      if (allowAdd && addType) {
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
        select.appendChild(separator);
        
        const addNew = document.createElement('option');
        addNew.value = '__ADD_NEW__';
        addNew.textContent = `ï¼‹ æ–°ã—ã„${addType}ã‚’è¿½åŠ `;
        select.appendChild(addNew);
      }
    }

    function updateExerciseOptions(select, card) {
      // éƒ¨ä½ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨
      let exercises;
      if (uiState.exerciseForm.selectedParts && uiState.exerciseForm.selectedParts.length > 0) {
        // é¸æŠã•ã‚ŒãŸéƒ¨ä½ã®ç¨®ç›®ã®ã¿ã‚’è¡¨ç¤º
        exercises = [];
        uiState.exerciseForm.selectedParts.forEach(partId => {
          exercises.push(...getAllExercises(partId));
        });
        exercises = sortForDisplay([...new Set(exercises)]); // é‡è¤‡ã‚’å‰Šé™¤
      } else {
        // éƒ¨ä½ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ã¦ã®ç¨®ç›®ã‚’è¡¨ç¤º
        exercises = sortForDisplay(getAllExercises(card.part));
      }
      
      const actual = card.exercise && exercises.includes(card.exercise) ? card.exercise : exercises[0] || '';
      select.innerHTML = '';
      exercises.forEach(value => {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = value;
        if (value === actual) opt.selected = true;
        select.appendChild(opt);
      });
      card.exercise = actual;
      
      // æ–°è¦è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      const separator = document.createElement('option');
      separator.disabled = true;
      separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
      select.appendChild(separator);
      
      const addNew = document.createElement('option');
      addNew.value = '__ADD_NEW__';
      addNew.textContent = 'ï¼‹ æ–°ã—ã„ç¨®ç›®ã‚’è¿½åŠ ';
      select.appendChild(addNew);
    }

    function buildItemsFromExerciseForm() {
      const idBase = Date.now();
      if (!uiState.exerciseForm.superset) {
        const card = uiState.exerciseForm.cards[0];
        return [buildItemFromCard(card, `${idBase}`)];
      }
      const groupId = createGroupId();
      return uiState.exerciseForm.cards.map((card, index) => buildItemFromCard(card, `${idBase}-${index}`, groupId));
    }

    function buildItemFromCard(card, keySeed, groupId = null) {
      return {
        id: createId('item'),
        order: state.day.items.length + 1,
        mode: groupId ? 'superset' : 'single',
        groupId,
        part: card.part,
        exercise: card.exercise,
        gear: card.gear,
        attachment: card.attachment,
        angle: card.angle,
        position: card.position,
        timed: card.timed,
        oneHand: card.oneHand,
        dropset: card.dropset,
        sets: []
      };
    }

    function prepareSetEditor(itemId, isNew = false) {
      const target = state.day.items.find(item => item.id === itemId);
      if (!target) return;
      let items = [];
      if (target.mode === 'superset' && target.groupId) {
        items = state.day.items.filter(item => item.groupId === target.groupId).sort((a, b) => a.order - b.order);
      } else {
        items = [target];
      }
      const editorItems = items.map((item, index) => ({
        itemId: item.id,
        label: ['A', 'B', 'C'][index] || 'A',
        timed: item.timed,
        dropset: item.dropset,
        mode: item.mode,
        rows: buildRowsFromSets(item.sets, item.timed)
      }));
      const maxRound = Math.max(-1, ...items.flatMap(item => item.sets.filter(set => set.round != null).map(set => set.round)));
      uiState.setEditor = {
        isSuperset: target.mode === 'superset',
        activeIndex: items.findIndex(item => item.id === itemId) || 0,
        items: editorItems,
        cycleBuffers: editorItems.map(item => createBuffer(item.timed)),
        nextRound: maxRound + 1,
        isNew
      };
    }

    function buildRowsFromSets(sets, timed) {
      const rows = [];
      let current = null;
      sets.sort((a, b) => a.ts - b.ts).forEach(set => {
        if (!set.drop) {
          current = createRowFromSet(set);
          rows.push(current);
        } else if (current) {
          current.drops.push(createDropFromSet(set));
        } else {
          const orphan = createRowFromSet(set);
          rows.push(orphan);
        }
      });
      if (rows.length === 0) {
        rows.push(createBlankRow(timed));
      }
      return rows;
    }

    function createRowFromSet(set) {
      return {
        id: set.id || createId('row'),
        weight: set.weight ?? '',
        repsU: set.repsU ?? '',
        repsA: set.repsA ?? '',
        seconds: set.seconds ?? '',
        warmup: !!set.warmup,
        round: set.round ?? null,
        drops: []
      };
    }

    function createDropFromSet(set) {
      return {
        id: set.id || createId('drop'),
        weight: set.weight ?? '',
        repsU: set.repsU ?? '',
        repsA: set.repsA ?? '',
        seconds: set.seconds ?? '',
        warmup: !!set.warmup,
        round: set.round ?? null
      };
    }

    function createBlankRow(timed, round = null) {
      return {
        id: createId('row'),
        weight: timed ? '' : '',
        repsU: '',
        repsA: '',
        seconds: timed ? '' : '',
        warmup: false,
        round,
        drops: [],
        memo: ''
      };
    }

    function createBlankDrop(timed, round = null) {
      return {
        id: createId('drop'),
        weight: timed ? '' : '',
        repsU: '',
        repsA: '',
        seconds: timed ? '' : '',
        warmup: false,
        round
      };
    }

    function createBuffer(timed) {
      return {
        row: createBlankRow(timed),
        drops: []
      };
    }
    
    // RMè¨ˆç®—é–¢æ•°
    function calculateEstimated1RM(weight, reps) {
      if (!weight || !reps || reps === 0) return null;
      // Epleyå¼: 1RM = é‡é‡ Ã— (1 + å›æ•° / 30)
      return Math.round(weight * (1 + reps / 30) * 10) / 10;
    }
    
    // éå»ã®æœ€é«˜è¨˜éŒ²ã‚’å–å¾—
    function getPersonalRecords(exercise, gear, attachment, angle, position) {
      const matchingWorkouts = state.history.filter(workout => {
        return workout.items.some(item => 
          item.exercise === exercise &&
          item.gear === gear &&
          item.attachment === attachment &&
          item.angle === angle &&
          item.position === position
        );
      });
      
      let maxWeight = 0;
      let maxEstimated1RM = 0;
      let bestSet = null;
      
      matchingWorkouts.forEach(workout => {
        workout.items.forEach(item => {
          if (item.exercise === exercise &&
              item.gear === gear &&
              item.attachment === attachment &&
              item.angle === angle &&
              item.position === position) {
            item.sets.forEach(set => {
              if (set.warmup) return; // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã¯é™¤å¤–
              const totalReps = (set.repsU || 0) + (set.repsA || 0);
              if (set.weight && set.weight > maxWeight) {
                maxWeight = set.weight;
              }
              const estimated1RM = calculateEstimated1RM(set.weight, totalReps);
              if (estimated1RM && estimated1RM > maxEstimated1RM) {
                maxEstimated1RM = estimated1RM;
                bestSet = { weight: set.weight, reps: totalReps, date: workout.date };
              }
            });
          }
        });
      });
      
      return {
        maxWeight,
        maxEstimated1RM,
        bestSet
      };
    }

    function renderSet() {
      const container = document.querySelector('[data-route="#/set"]');
      container.innerHTML = '';
      const editor = uiState.setEditor;
      if (!editor) {
        const message = document.createElement('p');
        message.className = 'text-sm text-slate-500';
        message.textContent = 'ç·¨é›†å¯¾è±¡ã®ç¨®ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
        container.appendChild(message);
        return;
      }
      const section = document.createElement('section');
      section.className = 'section-card bg-white p-4 space-y-4';

      // ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒƒãƒˆæ™‚ã¯ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆã‚»ãƒƒãƒˆï¼‰å˜ä½ã§è¡¨ç¤º
      if (editor.isSuperset) {
        renderSupersetByRound(editor, section);
      } else {
        // å˜ç‹¬ç¨®ç›®ã®å ´åˆ
        const active = editor.items[editor.activeIndex];
        activeEditSession = active; // è‡ªå‹•ä¿å­˜ç”¨ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
        const item = state.day.items.find(it => it.id === active.itemId);
        if (!item) {
          container.appendChild(section);
          return;
        }

        const subtitle = [item.gear, item.attachment, item.angle, item.position]
          .map(value => (value && value !== '-') ? value : 'â€•')
          .join(' / ');
        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-3 mb-2';
        const headerLeft = document.createElement('div');
        headerLeft.innerHTML = `
          <h2 class="text-lg font-light sumi-text" style="letter-spacing: 0.03em;">${item.exercise}</h2>
          <p class="text-[10px] sumi-text-light font-light mt-0.5">${subtitle}</p>
        `;
        header.appendChild(headerLeft);
        
        const editExerciseBtn = document.createElement('button');
        editExerciseBtn.type = 'button';
        editExerciseBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
        editExerciseBtn.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em;';
        editExerciseBtn.textContent = 'ç¨®ç›®ã‚’ç·¨é›†';
        editExerciseBtn.addEventListener('click', () => {
          // ç¾åœ¨ã®ç¨®ç›®æƒ…å ±ã‚’formStateã«è¨­å®š
          uiState.formState = {
            part: item.part,
            exercise: item.exercise,
            gear: item.gear,
            attachment: item.attachment,
            angle: item.angle,
            position: item.position,
            timed: item.timed,
            oneHand: item.oneHand
          };
          navigate('#/exercise');
        });
        header.appendChild(editExerciseBtn);
        section.appendChild(header);
        
        // éå»ã®æœ€é«˜è¨˜éŒ²ã‚’è¡¨ç¤º
        const records = getPersonalRecords(item.exercise, item.gear, item.attachment, item.angle, item.position);
        if (records.bestSet) {
          const recordInfo = document.createElement('div');
          recordInfo.className = 'text-xs sumi-text-light font-light py-2 px-3 rounded-lg';
          recordInfo.style.cssText = 'background-color: rgba(245, 237, 214, 0.15); border-left: 3px solid var(--color-gold);';
          const date = new Date(records.bestSet.date);
          const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
          recordInfo.innerHTML = `
            <span style="color: var(--color-gold);">ğŸ“Š</span> 
            <strong>æœ€é«˜è¨˜éŒ²:</strong> ${records.bestSet.weight}kgÃ—${records.bestSet.reps} 
            <span class="sumi-text-light">(æ¨å®š1RM: ${records.maxEstimated1RM}kg)</span>
            <span class="sumi-text-light ml-2">${dateStr}</span>
          `;
          section.appendChild(recordInfo);
        }

        const rowsWrapper = document.createElement('div');
        rowsWrapper.className = 'space-y-2.5';
        renderRows(active, rowsWrapper);
        section.appendChild(rowsWrapper);
      }

      // å…±é€šã®ãƒ•ãƒƒã‚¿ãƒ¼
      const footer = createSetFooter(editor);
      section.appendChild(footer);
      container.appendChild(section);
    }

    function renderSupersetByRound(editor, section) {
      // æœ€å¤§ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’å–å¾—
      const maxRounds = Math.max(...editor.items.map(item => {
        const rounds = new Set(item.rows.filter(r => r.round != null).map(r => r.round));
        return rounds.size > 0 ? Math.max(...rounds) : 0;
      }));

      // ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«è¡¨ç¤º
      for (let round = 0; round <= maxRounds; round++) {
        const roundCard = document.createElement('div');
        roundCard.className = 'border rounded-xl p-3 space-y-3';
        roundCard.style.borderColor = 'rgba(212, 175, 55, 0.25)';
        roundCard.style.backgroundColor = 'rgba(245, 237, 214, 0.05)';

        // å„ç¨®ç›®ã®ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
        editor.items.forEach((activeItem, itemIndex) => {
          const item = state.day.items.find(it => it.id === activeItem.itemId);
          if (!item) return;

          const rowsForRound = activeItem.rows.filter(r => r.round === round);
          if (rowsForRound.length === 0) return;

          const subtitle = [item.gear, item.attachment, item.angle, item.position]
            .map(value => (value && value !== '-') ? value : 'â€•')
            .join(' / ');

          const exerciseBlock = document.createElement('div');
          exerciseBlock.className = 'space-y-2';

          const header = document.createElement('div');
          header.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="text-xs font-light px-1.5 py-0.5 rounded" style="background-color: var(--color-gold); color: white;">${activeItem.label}</span>
              <h4 class="text-sm font-light sumi-text" style="letter-spacing: 0.02em;">${item.exercise}</h4>
            </div>
            <p class="text-[10px] sumi-text-light font-light mt-0.5">${subtitle}</p>
          `;
          exerciseBlock.appendChild(header);

          // ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
          rowsForRound.forEach((row, rowIndex) => {
            const actualRowIndex = activeItem.rows.indexOf(row);
            const rowCard = createSetInputCard(row, actualRowIndex, activeItem, item.timed, item.dropset);
            exerciseBlock.appendChild(rowCard);
          });

          roundCard.appendChild(exerciseBlock);
        });

        section.appendChild(roundCard);
      }

      // ã‚»ãƒƒãƒˆè¿½åŠ ãƒœã‚¿ãƒ³
      const addRoundBtn = document.createElement('button');
      addRoundBtn.type = 'button';
      addRoundBtn.className = 'w-full text-xs font-light px-3 py-2 bg-white rounded-lg min-h-[32px] border transition';
      addRoundBtn.style.borderColor = 'rgba(212, 175, 55, 0.2)';
      addRoundBtn.style.color = 'var(--color-gold)';
      addRoundBtn.textContent = 'ï¼‹ ãƒ©ã‚¦ãƒ³ãƒ‰è¿½åŠ ';
      addRoundBtn.addEventListener('click', () => {
        const nextRound = maxRounds + 1;
        editor.items.forEach(activeItem => {
          // ç›´å‰ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å–å¾—
          const lastRow = activeItem.rows[activeItem.rows.length - 1];
          
          activeItem.rows.push({
            round: nextRound,
            weight: lastRow && !activeItem.timed ? (lastRow.weight || null) : null,
            repsU: lastRow && !activeItem.timed ? (lastRow.repsU || null) : null,
            repsA: lastRow && !activeItem.timed ? (lastRow.repsA || 0) : 0,
            seconds: lastRow && activeItem.timed ? (lastRow.seconds || null) : null,
            warmup: false,
            drops: []
          });
        });
        renderSet();
      });
      section.appendChild(addRoundBtn);
    }

    function createSetInputCard(row, rowIndex, activeItem, isTimed, isDropsetEnabled) {
      const rowCard = document.createElement('div');
      rowCard.className = 'bg-white rounded-xl p-2.5 space-y-2 border border-neutral-200/40 shadow-sm';

      // 1è¡Œã«çµ±åˆ: ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ— + å…¥åŠ›æ¬„ + å‰Šé™¤ãƒœã‚¿ãƒ³
      const mainRow = document.createElement('div');
      mainRow.className = 'flex items-center gap-2 text-sm sumi-text';
      
      // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆå·¦ç«¯ï¼‰
      const warmupLabel = document.createElement('label');
      warmupLabel.className = 'inline-flex items-center gap-1 text-xs sumi-text-light cursor-pointer flex-shrink-0';
      const warmupInput = document.createElement('input');
      warmupInput.type = 'checkbox';
      warmupInput.className = 'w-4 h-4 rounded';
      warmupInput.style.accentColor = 'var(--color-gold)';
      warmupInput.checked = row.warmup;
      warmupInput.addEventListener('change', () => { row.warmup = warmupInput.checked; autoSaveDraft(); });
      warmupLabel.append(warmupInput, document.createTextNode('W'));
      mainRow.appendChild(warmupLabel);
      
      // å…¥åŠ›æ¬„ï¼ˆä¸­å¤®ï¼‰
      const inputsWrapper = document.createElement('div');
      inputsWrapper.className = 'flex gap-2 flex-1';
      if (isTimed) {
        inputsWrapper.appendChild(createCompactNumberInput('ç§’æ•°', row.seconds, value => { row.seconds = value; }));
      } else {
        inputsWrapper.appendChild(createCompactNumberInput('é‡é‡', row.weight, value => { row.weight = value; }));
        inputsWrapper.appendChild(createCompactNumberInput('è‡ªåŠ›', row.repsU, value => { row.repsU = value; }));
        inputsWrapper.appendChild(createCompactNumberInput('è£œåŠ©', row.repsA, value => { row.repsA = value; }, 0));
      }
      mainRow.appendChild(inputsWrapper);
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆå³ç«¯ã€Ã—ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full transition';
      removeBtn.style.cssText = 'color: var(--color-sumi-light); background-color: rgba(115, 115, 115, 0.05);';
      removeBtn.innerHTML = 'Ã—';
      removeBtn.style.fontSize = '20px';
      removeBtn.addEventListener('click', () => {
        activeItem.rows.splice(rowIndex, 1);
        renderSet();
      });
      removeBtn.addEventListener('mouseenter', () => {
        removeBtn.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
        removeBtn.style.color = '#ef4444';
      });
      removeBtn.addEventListener('mouseleave', () => {
        removeBtn.style.backgroundColor = 'rgba(115, 115, 115, 0.05)';
        removeBtn.style.color = 'var(--color-sumi-light)';
      });
      mainRow.appendChild(removeBtn);
      
      rowCard.appendChild(mainRow);

      // ã‚»ãƒƒãƒˆãƒ¡ãƒ¢å…¥åŠ›æ¬„ï¼ˆã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã®ä¸‹ï¼‰
      const memoInput = document.createElement('input');
      memoInput.type = 'text';
      memoInput.className = 'w-full px-2 py-1 text-xs rounded-lg border transition';
      memoInput.style.borderColor = 'rgba(212, 175, 55, 0.2)';
      memoInput.style.backgroundColor = 'rgba(245, 237, 214, 0.05)';
      memoInput.placeholder = 'ã‚»ãƒƒãƒˆãƒ¡ãƒ¢...';
      memoInput.value = row.memo || '';
      memoInput.addEventListener('input', () => { row.memo = memoInput.value; autoSaveDraft(); });
      memoInput.addEventListener('focus', () => {
        memoInput.style.outline = 'none';
        memoInput.style.borderColor = 'var(--color-gold)';
        memoInput.style.boxShadow = '0 0 0 3px rgba(212, 175, 55, 0.1)';
      });
      memoInput.addEventListener('blur', () => {
        memoInput.style.borderColor = 'rgba(212, 175, 55, 0.2)';
        memoInput.style.boxShadow = 'none';
      });
      rowCard.appendChild(memoInput);

      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆã‚¨ãƒªã‚¢ï¼ˆå¾Œã§å‰Šé™¤äºˆå®šï¼‰
      const dropArea = document.createElement('div');
      dropArea.className = 'space-y-2.5';
      row.drops.forEach((drop, dropIndex) => {
        const dropCard = document.createElement('div');
        dropCard.className = 'rounded-lg p-2.5 space-y-2 border border-dashed';
        dropCard.style.borderColor = 'rgba(212, 175, 55, 0.3)';
        dropCard.style.backgroundColor = 'rgba(245, 237, 214, 0.15)';
        const dropTitle = document.createElement('p');
        dropTitle.className = 'text-[10px] font-light';
        dropTitle.style.color = 'var(--color-gold)';
        dropTitle.textContent = 'ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
        dropCard.appendChild(dropTitle);
        const dropGrid = document.createElement('div');
        dropGrid.className = 'flex gap-2 text-sm sumi-text';
        if (isTimed) {
          dropGrid.appendChild(createCompactNumberInput('ç§’æ•°', drop.seconds, value => { drop.seconds = value; }));
        } else {
          dropGrid.appendChild(createCompactNumberInput('é‡é‡', drop.weight, value => { drop.weight = value; }));
          dropGrid.appendChild(createCompactNumberInput('è‡ªåŠ›', drop.repsU, value => { drop.repsU = value; }));
          dropGrid.appendChild(createCompactNumberInput('è£œåŠ©', drop.repsA, value => { drop.repsA = value; }, 0));
        }
        dropCard.appendChild(dropGrid);
        const dropToggle = document.createElement('label');
        dropToggle.className = 'inline-flex items-center gap-1 text-[10px] sumi-text-light cursor-pointer';
        const dropWarm = document.createElement('input');
        dropWarm.type = 'checkbox';
        dropWarm.className = 'w-3 h-3 rounded';
        dropWarm.style.accentColor = 'var(--color-gold)';
        dropWarm.checked = drop.warmup;
        dropWarm.addEventListener('change', () => { drop.warmup = dropWarm.checked; autoSaveDraft(); });
        dropToggle.append(dropWarm, document.createTextNode('W'));
        dropCard.appendChild(dropToggle);
        const dropFooter = document.createElement('div');
        dropFooter.className = 'flex justify-end';
        const dropRemove = document.createElement('button');
        dropRemove.type = 'button';
        dropRemove.className = 'text-[10px] font-light px-2 py-0.5 transition';
        dropRemove.style.color = 'var(--color-sumi-light)';
        dropRemove.textContent = 'å‰Šé™¤';
        dropRemove.addEventListener('click', () => {
          row.drops.splice(dropIndex, 1);
          renderSet();
        });
        dropFooter.appendChild(dropRemove);
        dropCard.appendChild(dropFooter);
        dropArea.appendChild(dropCard);
      });
      if (row.drops.length > 0) {
        rowCard.appendChild(dropArea);
      }

      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      if (isDropsetEnabled) {
        const addDropBtn = document.createElement('button');
        addDropBtn.type = 'button';
        addDropBtn.className = 'w-full text-[10px] font-light px-2 py-1.5 rounded-lg border transition';
        addDropBtn.style.borderColor = 'rgba(212, 175, 55, 0.2)';
        addDropBtn.style.color = 'var(--color-gold)';
        addDropBtn.textContent = 'ï¼‹ ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
        addDropBtn.addEventListener('click', () => {
          row.drops.push({
            weight: null,
            repsU: null,
            repsA: 0,
            seconds: null,
            warmup: false
          });
          renderSet();
        });
        rowCard.appendChild(addDropBtn);
      }

      return rowCard;
    }

    function renderRows(active, rowsWrapper) {
      // ç¾åœ¨ã®ç¨®ç›®ã®æœ€é«˜è¨˜éŒ²ã‚’å–å¾—
      const item = state.day.items.find(it => it.id === active.itemId);
      const records = item ? getPersonalRecords(item.exercise, item.gear, item.attachment, item.angle, item.position) : { maxEstimated1RM: 0 };
      
      active.rows.forEach((row, rowIndex) => {
        const rowCard = document.createElement('div');
        rowCard.className = 'bg-white rounded-xl p-2.5 space-y-2 border border-neutral-200/40 shadow-sm';
        if (row.round != null) {
          const title = document.createElement('div');
          title.className = 'flex items-center justify-between text-xs sumi-text-mid font-light';
          title.textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${row.round}`;
          rowCard.appendChild(title);
        }

        // è¨˜éŒ²æ›´æ–°ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«å¤–å´ã§å®šç¾©ï¼‰
        const checkNewRecord = () => {
          if (active.timed) return; // æ™‚é–“åˆ¶ã¯é™¤å¤–
          if (row.warmup) {
            // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã®å ´åˆã¯é€šå¸¸ã®èƒŒæ™¯è‰²ã«æˆ»ã™
            rowCard.style.backgroundColor = '';
            rowCard.style.borderColor = '';
            const badge = rowCard.querySelector('.new-record-badge');
            if (badge) badge.remove();
            return;
          }
          
          const totalReps = (row.repsU || 0) + (row.repsA || 0);
          const currentEstimated1RM = calculateEstimated1RM(row.weight, totalReps);
          
          if (currentEstimated1RM && currentEstimated1RM > records.maxEstimated1RM) {
            // æ–°è¨˜éŒ²ï¼
            rowCard.style.backgroundColor = 'rgba(34, 197, 94, 0.08)';
            rowCard.style.borderColor = 'rgba(34, 197, 94, 0.3)';
            
            // æ–°è¨˜éŒ²ãƒãƒƒã‚¸ãŒãªã‘ã‚Œã°è¿½åŠ 
            if (!rowCard.querySelector('.new-record-badge')) {
              const badge = document.createElement('div');
              badge.className = 'new-record-badge text-xs font-light px-2 py-0.5 rounded-full inline-block';
              badge.style.cssText = 'background-color: rgba(34, 197, 94, 0.15); color: rgb(34, 197, 94);';
              badge.textContent = 'ğŸ‰ æ–°è¨˜éŒ²ï¼';
              rowCard.insertBefore(badge, rowCard.firstChild);
            }
          } else {
            // é€šå¸¸ã®èƒŒæ™¯è‰²ã«æˆ»ã™
            rowCard.style.backgroundColor = '';
            rowCard.style.borderColor = '';
            
            // ãƒãƒƒã‚¸ã‚’å‰Šé™¤
            const badge = rowCard.querySelector('.new-record-badge');
            if (badge) badge.remove();
          }
        };

        const grid = document.createElement('div');
        grid.className = 'flex gap-2 text-sm sumi-text';
        if (active.timed) {
          grid.appendChild(createCompactNumberInput('ç§’æ•°', row.seconds, value => { row.seconds = value; }));
        } else {
          const weightInput = createCompactNumberInput('é‡é‡', row.weight, value => { 
            row.weight = value;
            checkNewRecord();
          });
          const repsUInput = createCompactNumberInput('è‡ªåŠ›', row.repsU, value => { 
            row.repsU = value;
            checkNewRecord();
          });
          const repsAInput = createCompactNumberInput('è£œåŠ©', row.repsA, value => { 
            row.repsA = value;
            checkNewRecord();
          }, 0);
          grid.appendChild(weightInput);
          grid.appendChild(repsUInput);
          grid.appendChild(repsAInput);
          
          // åˆæœŸãƒã‚§ãƒƒã‚¯
          checkNewRecord();
        }
        rowCard.appendChild(grid);

        const toggles = document.createElement('div');
        toggles.className = 'flex items-center justify-between gap-2 text-sm sumi-text';
        const warmupLabel = document.createElement('label');
        warmupLabel.className = 'inline-flex items-center gap-1 text-xs sumi-text-light cursor-pointer';
        const warmupInput = document.createElement('input');
        warmupInput.type = 'checkbox';
        warmupInput.className = 'w-3 h-3 rounded';
        warmupInput.style.accentColor = 'var(--color-gold)';
        warmupInput.checked = row.warmup;
        warmupInput.addEventListener('change', () => { 
          row.warmup = warmupInput.checked;
          checkNewRecord();
        });
        warmupLabel.append(warmupInput, document.createTextNode('W'));
        toggles.appendChild(warmupLabel);
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'text-xs font-light px-3 py-1 transition';
        removeBtn.style.color = 'var(--color-sumi-light)';
        removeBtn.textContent = 'ã“ã®ã‚»ãƒƒãƒˆã‚’å‰Šé™¤';
        removeBtn.addEventListener('click', () => {
          active.rows.splice(rowIndex, 1);
          if (active.rows.length === 0) {
            active.rows.push(createBlankRow(active.timed));
          }
          renderSet();
        });
        toggles.appendChild(removeBtn);
        rowCard.appendChild(toggles);

        // ã‚»ãƒƒãƒˆãƒ¡ãƒ¢å…¥åŠ›æ¬„ï¼ˆã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã®ä¸‹ï¼‰
        const memoInput = document.createElement('input');
        memoInput.type = 'text';
        memoInput.className = 'w-full px-2 py-1 text-xs rounded-lg border transition';
        memoInput.style.borderColor = 'rgba(212, 175, 55, 0.2)';
        memoInput.style.backgroundColor = 'rgba(245, 237, 214, 0.05)';
        memoInput.placeholder = 'ã‚»ãƒƒãƒˆãƒ¡ãƒ¢...';
        memoInput.value = row.memo || '';
        memoInput.addEventListener('input', () => { row.memo = memoInput.value; autoSaveDraft(); });
        memoInput.addEventListener('focus', () => {
          memoInput.style.outline = 'none';
          memoInput.style.borderColor = 'var(--color-gold)';
          memoInput.style.boxShadow = '0 0 0 3px rgba(212, 175, 55, 0.1)';
        });
        memoInput.addEventListener('blur', () => {
          memoInput.style.borderColor = 'rgba(212, 175, 55, 0.2)';
          memoInput.style.boxShadow = 'none';
        });
        rowCard.appendChild(memoInput);

        const dropArea = document.createElement('div');
        dropArea.className = 'space-y-2.5';
        row.drops.forEach((drop, dropIndex) => {
          const dropCard = document.createElement('div');
          dropCard.className = 'rounded-lg p-2.5 space-y-2 border border-dashed';
          dropCard.style.borderColor = 'rgba(212, 175, 55, 0.3)';
          dropCard.style.backgroundColor = 'rgba(245, 237, 214, 0.15)';
          const dropTitle = document.createElement('p');
          dropTitle.className = 'text-[10px] font-light';
          dropTitle.style.color = 'var(--color-gold)';
          dropTitle.textContent = 'ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
          dropCard.appendChild(dropTitle);
          const dropGrid = document.createElement('div');
          dropGrid.className = 'flex gap-2 text-sm sumi-text';
          if (active.timed) {
            dropGrid.appendChild(createCompactNumberInput('ç§’æ•°', drop.seconds, value => { drop.seconds = value; }));
          } else {
            dropGrid.appendChild(createCompactNumberInput('é‡é‡', drop.weight, value => { drop.weight = value; }));
            dropGrid.appendChild(createCompactNumberInput('è‡ªåŠ›', drop.repsU, value => { drop.repsU = value; }));
            dropGrid.appendChild(createCompactNumberInput('è£œåŠ©', drop.repsA, value => { drop.repsA = value; }, 0));
          }
          dropCard.appendChild(dropGrid);
          const dropToggle = document.createElement('label');
          dropToggle.className = 'inline-flex items-center gap-1 text-[10px] sumi-text-light cursor-pointer';
          const dropWarm = document.createElement('input');
          dropWarm.type = 'checkbox';
          dropWarm.className = 'w-3 h-3 rounded';
          dropWarm.style.accentColor = 'var(--color-gold)';
          dropWarm.checked = drop.warmup;
          dropWarm.addEventListener('change', () => { drop.warmup = dropWarm.checked; autoSaveDraft(); });
          dropToggle.append(dropWarm, document.createTextNode('W'));
          dropCard.appendChild(dropToggle);
          const dropFooter = document.createElement('div');
          dropFooter.className = 'flex justify-end';
          const dropRemove = document.createElement('button');
          dropRemove.type = 'button';
          dropRemove.className = 'text-[10px] font-light px-2 py-0.5 transition';
          dropRemove.style.color = 'var(--color-sumi-light)';
          dropRemove.textContent = 'å‰Šé™¤';
          dropRemove.addEventListener('click', () => {
            row.drops.splice(dropIndex, 1);
            renderSet();
          });
          dropFooter.appendChild(dropRemove);
          dropCard.appendChild(dropFooter);
          dropArea.appendChild(dropCard);
        });
        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        if (active.dropset) {
          const addDropBtn = document.createElement('button');
          addDropBtn.type = 'button';
          addDropBtn.className = 'w-full text-xs font-light px-4 py-2 bg-white rounded-xl min-h-[36px] border transition';
          addDropBtn.style.borderColor = 'rgba(212, 175, 55, 0.2)';
          addDropBtn.style.color = 'var(--color-gold)';
          addDropBtn.textContent = 'ï¼‹ ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
          addDropBtn.addEventListener('click', () => {
            row.drops.push(createBlankDrop(active.timed, row.round));
            renderSet();
          });
          dropArea.appendChild(addDropBtn);
        }
        rowCard.appendChild(dropArea);

        rowsWrapper.appendChild(rowCard);
      });
      
      const addSetBtn = document.createElement('button');
      addSetBtn.type = 'button';
      addSetBtn.className = 'w-full text-xs font-light px-3 py-2 bg-white rounded-lg min-h-[32px] border transition';
      addSetBtn.style.borderColor = 'rgba(212, 175, 55, 0.2)';
      addSetBtn.style.color = 'var(--color-gold)';
      addSetBtn.textContent = 'ï¼‹ ã‚»ãƒƒãƒˆè¿½åŠ ';
      addSetBtn.addEventListener('click', () => {
        // ç›´å‰ã®ã‚»ãƒƒãƒˆã‚’å–å¾—
        const lastRow = active.rows[active.rows.length - 1];
        
        // ç›´å‰ã®ã‚»ãƒƒãƒˆã®å†…å®¹ã‚’å¼•ãç¶™ã
        const newRow = createBlankRow(active.timed);
        if (lastRow && !active.timed) {
          newRow.weight = lastRow.weight || null;
          newRow.repsU = lastRow.repsU || null;
          newRow.repsA = lastRow.repsA || null;
          // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã¨ãƒ¡ãƒ¢ã¯ãƒªã‚»ãƒƒãƒˆ
          newRow.warmup = false;
          newRow.memo = '';
        }
        
        active.rows.push(newRow);
        renderSet();
      });
      rowsWrapper.appendChild(addSetBtn);
    }

    function createSetFooter(editor) {
      const footer = document.createElement('div');
      footer.className = 'flex flex-col sm:flex-row gap-2.5 justify-between pt-2';
      const saveBack = document.createElement('button');
      saveBack.type = 'button';
      saveBack.className = 'ios-card text-white px-6 py-3 font-light min-h-[44px] transition';
      saveBack.style.backgroundColor = 'var(--color-gold)';
      saveBack.style.letterSpacing = '0.05em';
      saveBack.textContent = 'ä¿å­˜ã—ã¦æˆ»ã‚‹';
      saveBack.addEventListener('click', () => {
        persistSetEditor();
        navigate('#/today');
      });
      const saveNext = document.createElement('button');
      saveNext.type = 'button';
      saveNext.className = 'ios-card bg-white px-6 py-3 font-light min-h-[44px] border transition';
      saveNext.style.borderColor = 'rgba(212, 175, 55, 0.3)';
      saveNext.style.color = 'var(--color-gold)';
      saveNext.textContent = 'æ¬¡ã®ç¨®ç›®ã¸';
      saveNext.addEventListener('click', () => {
        persistSetEditor();
        uiState.exerciseForm = createExerciseFormState();
        navigate('#/exercise');
      });
      footer.append(saveBack, saveNext);
      return footer;
    }

    function renderRoundBuffer(editor) {
      const wrapper = document.createElement('div');
      wrapper.className = 'space-y-4 bg-indigo-50 rounded-2xl p-4 border border-indigo-200';
      const title = document.createElement('div');
      title.className = 'flex items-center justify-between';
      title.innerHTML = `
        <div>
          <p class="text-sm font-semibold text-indigo-700">ãƒ©ã‚¦ãƒ³ãƒ‰å…¥åŠ›</p>
          <p class="text-xs text-indigo-500">ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ç•ªå·: ${editor.nextRound}</p>
        </div>
        <button type="button" class="ios-card bg-indigo-500 text-white px-4 py-2 text-sm font-semibold min-h-[40px]" id="nextRoundBtn">æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
      `;
      wrapper.appendChild(title);
      const activeBuffer = editor.cycleBuffers[editor.activeIndex];
      const activeItem = editor.items[editor.activeIndex];
      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-indigo-700';
      if (activeItem.timed) {
        grid.appendChild(createNumberInput('ç§’æ•°', activeBuffer.row.seconds, value => { activeBuffer.row.seconds = value; }));
      } else {
        grid.appendChild(createNumberInput('é‡é‡(kg)', activeBuffer.row.weight, value => { activeBuffer.row.weight = value; }));
        grid.appendChild(createNumberInput('è‡ªåŠ›ãƒ¬ãƒƒãƒ—', activeBuffer.row.repsU, value => { activeBuffer.row.repsU = value; }));
        grid.appendChild(createNumberInput('è£œåŠ©ãƒ¬ãƒƒãƒ—', activeBuffer.row.repsA, value => { activeBuffer.row.repsA = value; }, 0));
      }
      wrapper.appendChild(grid);
      const warmupRow = document.createElement('label');
      warmupRow.className = 'inline-flex items-center gap-1 text-xs sumi-text-light min-h-[32px]';
      const warmupInput = document.createElement('input');
      warmupInput.type = 'checkbox';
      warmupInput.className = 'w-3 h-3 rounded';
      warmupInput.style.accentColor = 'var(--color-gold)';
      warmupInput.checked = activeBuffer.row.warmup;
      warmupInput.addEventListener('change', () => { activeBuffer.row.warmup = warmupInput.checked; autoSaveDraft(); });
      warmupRow.append(warmupInput, document.createTextNode('W'));
      wrapper.appendChild(warmupRow);

      activeBuffer.drops.forEach((drop, index) => {
        const dropCard = document.createElement('div');
        dropCard.className = 'bg-white rounded-2xl p-4 space-y-3 border border-dashed border-indigo-200';
        const dropTitle = document.createElement('p');
        dropTitle.className = 'text-xs font-semibold text-indigo-600';
        dropTitle.textContent = 'ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
        dropCard.appendChild(dropTitle);
        const dropGrid = document.createElement('div');
        dropGrid.className = 'grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-indigo-700';
        if (activeItem.timed) {
          dropGrid.appendChild(createNumberInput('ç§’æ•°', drop.seconds, value => { drop.seconds = value; }));
        } else {
          dropGrid.appendChild(createNumberInput('é‡é‡(kg)', drop.weight, value => { drop.weight = value; }));
          dropGrid.appendChild(createNumberInput('è‡ªåŠ›ãƒ¬ãƒƒãƒ—', drop.repsU, value => { drop.repsU = value; }));
          dropGrid.appendChild(createNumberInput('è£œåŠ©ãƒ¬ãƒƒãƒ—', drop.repsA, value => { drop.repsA = value; }, 0));
        }
        dropCard.appendChild(dropGrid);
        const dropToggle = document.createElement('label');
        dropToggle.className = 'inline-flex items-center gap-1 text-xs sumi-text-light min-h-[32px]';
        const dropWarm = document.createElement('input');
        dropWarm.type = 'checkbox';
        dropWarm.className = 'w-3 h-3 rounded';
        dropWarm.style.accentColor = 'var(--color-gold)';
        dropWarm.checked = drop.warmup;
        dropWarm.addEventListener('change', () => { drop.warmup = dropWarm.checked; autoSaveDraft(); });
        dropToggle.append(dropWarm, document.createTextNode('W'));
        dropCard.appendChild(dropToggle);
        const dropFooter = document.createElement('div');
        dropFooter.className = 'flex justify-end';
        const dropRemove = document.createElement('button');
        dropRemove.type = 'button';
        dropRemove.className = 'text-xs text-rose-500 font-semibold px-3 py-1 min-h-[32px]';
        dropRemove.textContent = 'å‰Šé™¤';
        dropRemove.addEventListener('click', () => {
          activeBuffer.drops.splice(index, 1);
          renderSet();
        });
        dropFooter.appendChild(dropRemove);
        dropCard.appendChild(dropFooter);
        wrapper.appendChild(dropCard);
      });

      const addDropBtn = document.createElement('button');
      addDropBtn.type = 'button';
      addDropBtn.className = 'w-full text-xs text-indigo-500 font-semibold px-4 py-2 bg-white rounded-2xl min-h-[40px]';
      addDropBtn.textContent = 'ï¼‹ ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
      addDropBtn.addEventListener('click', () => {
        activeBuffer.drops.push(createBlankDrop(activeItem.timed));
        renderSet();
      });
      wrapper.appendChild(addDropBtn);

      wrapper.querySelector('#nextRoundBtn').addEventListener('click', () => {
        advanceRoundCycle();
      });

      return wrapper;
    }

    function createCompactNumberInput(labelText, value, onInput, min = 0) {
      const wrapper = document.createElement('label');
      wrapper.className = 'flex-1 flex flex-col gap-1';
      const label = document.createElement('span');
      label.className = 'text-[10px] sumi-text-mid font-light';
      label.textContent = labelText;
      wrapper.appendChild(label);
      const input = document.createElement('input');
      input.type = 'number';
      input.inputMode = 'numeric';
      input.min = String(min);
      input.value = value ?? '';
      input.className = 'rounded-lg border px-2 py-1.5 text-sm sumi-text font-light transition focus:outline-none focus:ring-1 w-full';
      input.style.borderColor = 'rgba(115, 115, 115, 0.2)';
      input.style.backgroundColor = 'rgba(250, 250, 250, 0.5)';
      input.addEventListener('focus', () => {
        input.style.borderColor = 'var(--color-gold)';
        input.style.backgroundColor = 'rgba(245, 237, 214, 0.1)';
      });
      input.addEventListener('blur', () => {
        input.style.borderColor = 'rgba(115, 115, 115, 0.2)';
        input.style.backgroundColor = 'rgba(250, 250, 250, 0.5)';
      });
      input.addEventListener('input', () => {
        const numValue = input.value === '' ? null : Number(input.value);
        onInput(numValue);
        autoSaveDraft(); // è‡ªå‹•ä¿å­˜
      });
      wrapper.appendChild(input);
      return wrapper;
    }

    function createNumberInput(labelText, value, onInput, min = 0) {
      const wrapper = document.createElement('label');
      wrapper.className = 'flex flex-col gap-1.5';
      const label = document.createElement('span');
      label.className = 'text-xs sumi-text-mid font-light';
      label.textContent = labelText;
      wrapper.appendChild(label);
      const input = document.createElement('input');
      input.type = 'number';
      input.inputMode = 'numeric';
      input.min = String(min);
      input.value = value ?? '';
      input.className = 'rounded-lg border px-3 py-2 text-sm sumi-text font-light transition focus:outline-none focus:ring-1';
      input.style.borderColor = 'rgba(115, 115, 115, 0.2)';
      input.style.backgroundColor = 'rgba(250, 250, 250, 0.5)';
      input.addEventListener('focus', () => {
        input.style.borderColor = 'var(--color-gold)';
        input.style.backgroundColor = 'rgba(245, 237, 214, 0.1)';
      });
      input.addEventListener('blur', () => {
        input.style.borderColor = 'rgba(115, 115, 115, 0.2)';
        input.style.backgroundColor = 'rgba(250, 250, 250, 0.5)';
      });
      input.addEventListener('input', () => {
        const numValue = input.value === '' ? null : Number(input.value);
        onInput(numValue);
        autoSaveDraft(); // è‡ªå‹•ä¿å­˜
      });
      wrapper.appendChild(input);
      return wrapper;
    }

    function bufferHasData(buffer, timed) {
      if (timed) {
        return buffer.row.seconds !== '' || buffer.drops.some(drop => drop.seconds !== '');
      }
      const baseFilled = buffer.row.weight !== '' || buffer.row.repsU !== '' || buffer.row.repsA !== '';
      const dropFilled = buffer.drops.some(drop => drop.weight !== '' || drop.repsU !== '' || drop.repsA !== '');
      return baseFilled || dropFilled;
    }

    function advanceRoundCycle() {
      const editor = uiState.setEditor;
      if (!editor || !editor.isSuperset) return;
      const buffer = editor.cycleBuffers[editor.activeIndex];
      editor.activeIndex = (editor.activeIndex + 1) % editor.items.length;
      if (editor.activeIndex === 0) {
        finalizeRoundBuffer();
      } else {
        renderSet();
      }
    }

    function finalizeRoundBuffer() {
      const editor = uiState.setEditor;
      if (!editor) return;
      const entries = editor.cycleBuffers.map((buffer, index) => {
        const item = editor.items[index];
        if (!bufferHasData(buffer, item.timed)) return null;
        const row = createBlankRow(item.timed, editor.nextRound);
        row.weight = buffer.row.weight;
        row.repsU = buffer.row.repsU;
        row.repsA = buffer.row.repsA;
        row.seconds = buffer.row.seconds;
        row.warmup = buffer.row.warmup;
        row.drops = buffer.drops.map(drop => ({
          id: createId('drop'),
          weight: drop.weight,
          repsU: drop.repsU,
          repsA: drop.repsA,
          seconds: drop.seconds,
          warmup: drop.warmup,
          round: editor.nextRound
        }));
        return row;
      });
      const hasAny = entries.some(entry => entry !== null);
      if (hasAny) {
        entries.forEach((row, index) => {
          if (!row) return;
          editor.items[index].rows.push(row);
        });
        editor.nextRound += 1;
      }
      editor.cycleBuffers = editor.items.map(item => createBuffer(item.timed));
      renderSet();
    }

    function persistSetEditor() {
      const editor = uiState.setEditor;
      if (!editor) return;
      editor.items.forEach(itemState => {
        const item = state.day.items.find(it => it.id === itemState.itemId);
        if (!item) return;
        const newSets = [];
        itemState.rows.forEach(row => {
          const built = buildSetsFromRow(row, itemState.timed);
          built.forEach(set => newSets.push(set));
        });
        item.sets = newSets;
      });
      state.day.items.sort((a, b) => a.order - b.order).forEach((entry, index) => {
        entry.order = index + 1;
      });
      renderToday();
    }

    function buildSetsFromRow(row, timed) {
      const sets = [];
      const base = convertRowToSet(row, timed, false);
      if (base) sets.push(base);
      row.drops.forEach(drop => {
        const dropSet = convertRowToSet({ ...drop, round: drop.round ?? row.round }, timed, true);
        if (dropSet) sets.push(dropSet);
      });
      return sets;
    }

    function convertRowToSet(row, timed, isDrop) {
      if (timed) {
        const seconds = parseNumber(row.seconds);
        if (seconds == null) return null;
        return createSet({ seconds, warmup: !!row.warmup, drop: isDrop, round: row.round ?? null });
      }
      const weight = parseNumber(row.weight);
      const repsU = parseNumber(row.repsU);
      const repsA = parseNumber(row.repsA);
      if (weight == null && repsU == null && repsA == null) return null;
      return createSet({ weight, repsU, repsA, warmup: !!row.warmup, drop: isDrop, round: row.round ?? null });
    }

    function parseNumber(value) {
      if (value === '' || value === null || value === undefined) return null;
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    }

    function renderHistory() {
      const container = document.querySelector('[data-route="#/history"]');
      container.innerHTML = '';
      
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-3';
      const title = document.createElement('h1');
      title.className = 'text-lg font-light sumi-text';
      title.style.letterSpacing = '0.05em';
      title.textContent = 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´';
      header.appendChild(title);
      const homeButton = document.createElement('button');
      homeButton.type = 'button';
      homeButton.className = 'flex items-center gap-1 text-sm font-light sumi-text-light hover:sumi-text transition min-h-[44px] px-3';
      homeButton.innerHTML = 'â† ãƒ›ãƒ¼ãƒ ';
      homeButton.addEventListener('click', () => navigate('#/dashboard'));
      header.appendChild(homeButton);
      container.appendChild(header);
      
      if (state.history.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'section-card bg-white p-6 text-center';
        empty.innerHTML = `
          <p class="text-sm sumi-text-light font-light">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p class="text-xs sumi-text-light font-light mt-2">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å®Œäº†ã™ã‚‹ã¨å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã¾ã™</p>
        `;
        container.appendChild(empty);
        return;
      }
      
      const list = document.createElement('div');
      list.className = 'space-y-3';
      
      state.history.forEach((workout, workoutIndex) => {
        const card = document.createElement('article');
        card.className = 'section-card bg-white p-4 space-y-3';
        
        const header = document.createElement('div');
        header.className = 'flex items-start justify-between gap-3';
        const date = new Date(workout.date);
        const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        const headerLeft = document.createElement('div');
        headerLeft.className = 'min-w-0';
        headerLeft.innerHTML = `
          <p class="text-base font-light sumi-text" style="letter-spacing: 0.02em;">${dateStr}</p>
          <p class="text-xs font-light sumi-text-light">${workout.items.length}ç¨®ç›®</p>
        `;
        header.appendChild(headerLeft);
        
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'flex gap-2';
        
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
        editBtn.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em;';
        editBtn.textContent = 'ç·¨é›†';
        editBtn.addEventListener('click', () => {
          loadHistoryForEdit(workoutIndex);
        });
        buttonGroup.appendChild(editBtn);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
        deleteBtn.style.cssText = 'background-color: rgba(254, 226, 226, 0.5); color: #dc2626; border-color: rgba(220, 38, 38, 0.3); letter-spacing: 0.05em;';
        deleteBtn.textContent = 'å‰Šé™¤';
        deleteBtn.addEventListener('click', () => {
          deleteWorkout(workoutIndex);
        });
        buttonGroup.appendChild(deleteBtn);
        
        header.appendChild(buttonGroup);
        card.appendChild(header);
        
        const itemsList = document.createElement('div');
        itemsList.className = 'space-y-2';
        
        const sortedItems = [...workout.items].sort((a, b) => a.order - b.order);
        const processedGroups = new Set();
        
        sortedItems.forEach(item => {
          if (item.mode === 'superset') {
            if (!item.groupId || processedGroups.has(item.groupId)) return;
            const groupItems = sortedItems.filter(candidate => candidate.groupId === item.groupId);
            processedGroups.add(item.groupId);
            itemsList.appendChild(buildHistorySuperset(groupItems));
          } else {
            itemsList.appendChild(buildHistorySingle(item));
          }
        });
        
        card.appendChild(itemsList);
        
        // ãƒ¡ãƒ¢ã‚’è¡¨ç¤º
        if (workout.memo && workout.memo.trim()) {
          const memoDiv = document.createElement('div');
          memoDiv.className = 'p-3 rounded-lg border border-dashed';
          memoDiv.style.cssText = 'border-color: rgba(212, 175, 55, 0.3); background-color: rgba(245, 237, 214, 0.1);';
          const memoLabel = document.createElement('p');
          memoLabel.className = 'text-xs font-light mb-1';
          memoLabel.style.color = 'var(--color-gold)';
          memoLabel.textContent = 'ãƒ¡ãƒ¢';
          const memoText = document.createElement('p');
          memoText.className = 'text-sm font-light sumi-text whitespace-pre-wrap';
          memoText.textContent = workout.memo;
          memoDiv.appendChild(memoLabel);
          memoDiv.appendChild(memoText);
          card.appendChild(memoDiv);
        }
        
        list.appendChild(card);
      });
      
      container.appendChild(list);
    }
    
    function buildHistorySingle(item) {
      const div = document.createElement('div');
      div.className = 'p-3 rounded-lg border border-neutral-200/40';
      
      const partLabel = state.master.parts.find(p => p.id === item.part)?.label ?? '';
      const header = document.createElement('div');
      header.className = 'flex items-start justify-between gap-2 mb-2';
      header.innerHTML = `
        <div class="min-w-0">
          <p class="text-sm font-light sumi-text" style="letter-spacing: 0.02em;">${item.exercise}</p>
          <p class="text-xs font-light sumi-text-light">${partLabel}</p>
        </div>
        <div class="text-xs font-light sumi-text-light text-right min-w-0 truncate">
          ${[item.gear, item.angle, item.position].map(val => val && val !== '-' ? val : 'â€•').join(' / ')}
        </div>
      `;
      div.appendChild(header);
      
      const workSets = item.sets.filter(s => !s.warmup);
      const setsText = workSets.map(s => {
        if (s.seconds != null) return `${s.seconds}ç§’`;
        const parts = [];
        if (s.weight != null) parts.push(`${s.weight}kg`);
        if (s.repsU != null) parts.push(`Ã—${s.repsU}`);
        return parts.join('');
      }).join(', ');
      
      const setsDiv = document.createElement('div');
      setsDiv.className = 'text-xs font-light sumi-text-light';
      setsDiv.textContent = setsText || 'ã‚»ãƒƒãƒˆãªã—';
      div.appendChild(setsDiv);
      
      return div;
    }
    
    function buildHistorySuperset(groupItems) {
      const sorted = [...groupItems].sort((a, b) => a.order - b.order);
      const labels = ['A', 'B', 'C'];
      const title = `(SS) ${sorted.map(item => item.exercise).join(' + ')}`;
      
      const div = document.createElement('div');
      div.className = 'p-3 rounded-lg border border-neutral-200/40';
      
      const header = document.createElement('div');
      header.className = 'flex items-start justify-between gap-2 mb-2';
      header.innerHTML = `
        <div class="min-w-0">
          <p class="text-sm font-light sumi-text" style="letter-spacing: 0.02em;">${title}</p>
          <p class="text-xs font-light sumi-text-light">${sorted.map((item, index) => `${labels[index]}. ${state.master.parts.find(p => p.id === item.part)?.label ?? ''}`).join(' / ')}</p>
        </div>
      `;
      div.appendChild(header);
      
      const rounds = buildSupersetRounds(sorted);
      const roundsText = `${rounds.length}ãƒ©ã‚¦ãƒ³ãƒ‰`;
      const roundsDiv = document.createElement('div');
      roundsDiv.className = 'text-xs font-light sumi-text-light';
      roundsDiv.textContent = roundsText;
      div.appendChild(roundsDiv);
      
      return div;
    }

    // LocalStorage functions
    function saveHistory() {
      try {
        localStorage.setItem('muscleRoutineHistory', JSON.stringify(state.history));
        localStorage.setItem('muscleRoutineHistoryVersion', '1');
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    function loadHistory() {
      try {
        const saved = localStorage.getItem('muscleRoutineHistory');
        if (saved) {
          state.history = JSON.parse(saved);
        }
      } catch (e) {
        console.error('Failed to load history:', e);
        state.history = [];
      }
    }

    function deleteWorkout(workoutIndex) {
      const workout = state.history[workoutIndex];
      const date = new Date(workout.date);
      const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
      
      const confirmed = confirm(`${dateStr}ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`);
      if (!confirmed) return;
      
      // å±¥æ­´ã‹ã‚‰å‰Šé™¤
      state.history.splice(workoutIndex, 1);
      saveHistory();
      
      // ç”»é¢ã‚’å†æç”»
      render();
      
      alert('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    }
    
    function loadHistoryForEdit(historyIndex) {
      // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’state.dayã«èª­ã¿è¾¼ã‚€
      const workout = state.history[historyIndex];
      state.day = {
        date: workout.date,
        memo: workout.memo || '',
        items: JSON.parse(JSON.stringify(workout.items)) // deep copy
      };
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
      uiState.editingHistoryIndex = historyIndex;
      
      // ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ã«é·ç§»
      navigate('#/today');
    }

    function completeWorkout() {
      const isEditing = uiState.editingHistoryIndex !== null;
      
      if (isEditing) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šå±¥æ­´ã‚’æ›´æ–°
        const workout = {
          date: state.day.date,
          memo: state.day.memo || '',
          items: JSON.parse(JSON.stringify(state.day.items)), // deep copy
          completedAt: state.history[uiState.editingHistoryIndex].completedAt,
          updatedAt: new Date().toISOString()
        };
        state.history[uiState.editingHistoryIndex] = workout;
        saveHistory();
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
        uiState.editingHistoryIndex = null;
        
        // æ–°ã—ã„æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        state.day = {
          date: new Date().toISOString().slice(0, 10),
          memo: '',
          items: []
        };
        
        alert('å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
        navigate('#/history'); // å±¥æ­´ç”»é¢ã«æˆ»ã‚‹
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’historyã«è¿½åŠ 
        const workout = {
          date: state.day.date,
          memo: state.day.memo || '',
          items: JSON.parse(JSON.stringify(state.day.items)), // deep copy
          completedAt: new Date().toISOString()
        };
        state.history.unshift(workout); // æœ€æ–°ã‚’å…ˆé ­ã«
        saveHistory();
        
        // æ–°ã—ã„æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        state.day = {
          date: new Date().toISOString().slice(0, 10),
          memo: '',
          items: []
        };
        
        clearDraft(); // ä¸‹æ›¸ãã‚’ã‚¯ãƒªã‚¢
        alert('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’å®Œäº†ã—ã¾ã—ãŸï¼\nå¼•ãç¶šãç·¨é›†ã§ãã¾ã™ã€‚');
        render(); // ç”»é¢ã‚’å†æç”»
      }
    }

    function renderSettings() {
      const container = document.querySelector('[data-route="#/settings"]');
      container.innerHTML = '';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-3';
      const title = document.createElement('h1');
      title.className = 'text-lg font-light sumi-text';
      title.style.letterSpacing = '0.05em';
      title.textContent = 'è¨­å®š';
      header.appendChild(title);
      const homeButton = document.createElement('button');
      homeButton.type = 'button';
      homeButton.className = 'flex items-center gap-1 text-sm font-light sumi-text-light hover:sumi-text transition min-h-[44px] px-3';
      homeButton.innerHTML = 'â† ãƒ›ãƒ¼ãƒ ';
      homeButton.addEventListener('click', () => navigate('#/dashboard'));
      header.appendChild(homeButton);
      container.appendChild(header);
      
      // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      const dataSection = document.createElement('section');
      dataSection.className = 'section-card bg-white p-4 space-y-4';
      
      const dataSectionTitle = document.createElement('h2');
      dataSectionTitle.className = 'text-base font-light sumi-text';
      dataSectionTitle.style.letterSpacing = '0.05em';
      dataSectionTitle.textContent = 'ãƒ‡ãƒ¼ã‚¿ç®¡ç†';
      dataSection.appendChild(dataSectionTitle);
      
      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
      const exportBtn = document.createElement('button');
      exportBtn.type = 'button';
      exportBtn.className = 'w-full ios-card bg-white px-4 py-3 text-sm font-light transition min-h-[44px] border';
      exportBtn.style.cssText = 'border-color: rgba(212, 175, 55, 0.3); color: var(--color-gold); letter-spacing: 0.05em;';
      exportBtn.textContent = 'ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
      exportBtn.addEventListener('click', exportData);
      dataSection.appendChild(exportBtn);
      
      // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
      const importBtn = document.createElement('button');
      importBtn.type = 'button';
      importBtn.className = 'w-full ios-card bg-white px-4 py-3 text-sm font-light transition min-h-[44px] border';
      importBtn.style.cssText = 'border-color: rgba(212, 175, 55, 0.3); color: var(--color-gold); letter-spacing: 0.05em;';
      importBtn.textContent = 'ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ';
      importBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) importData(file);
        });
        input.click();
      });
      dataSection.appendChild(importBtn);
      
      // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.className = 'w-full ios-card bg-white px-4 py-3 text-sm font-light transition min-h-[44px] border';
      clearBtn.style.cssText = 'border-color: rgba(220, 38, 38, 0.3); color: #dc2626; letter-spacing: 0.05em;';
      clearBtn.textContent = 'ğŸ—‘ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤';
      clearBtn.addEventListener('click', clearAllData);
      dataSection.appendChild(clearBtn);
      
      container.appendChild(dataSection);
      
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      const customDataSection = document.createElement('section');
      customDataSection.className = 'section-card bg-white p-4 space-y-4';
      
      const customDataSectionTitle = document.createElement('h2');
      customDataSectionTitle.className = 'text-base font-light sumi-text';
      customDataSectionTitle.style.letterSpacing = '0.05em';
      customDataSectionTitle.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ç®¡ç†';
      customDataSection.appendChild(customDataSectionTitle);
      
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³
      const manageCustomDataBtn = document.createElement('button');
      manageCustomDataBtn.type = 'button';
      manageCustomDataBtn.className = 'w-full ios-card bg-white px-4 py-3 text-sm font-light transition min-h-[44px] border';
      manageCustomDataBtn.style.cssText = 'border-color: rgba(139, 92, 246, 0.3); color: var(--color-purple); letter-spacing: 0.05em;';
      manageCustomDataBtn.textContent = 'âš™ï¸ ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†';
      manageCustomDataBtn.addEventListener('click', showCustomDataManagement);
      customDataSection.appendChild(manageCustomDataBtn);
      
      container.appendChild(customDataSection);
      
      // ã‚¢ãƒ—ãƒªæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
      const infoSection = document.createElement('section');
      infoSection.className = 'section-card bg-white p-4 space-y-3';
      
      const infoSectionTitle = document.createElement('h2');
      infoSectionTitle.className = 'text-base font-light sumi-text';
      infoSectionTitle.style.letterSpacing = '0.05em';
      infoSectionTitle.textContent = 'ã‚¢ãƒ—ãƒªæƒ…å ±';
      infoSection.appendChild(infoSectionTitle);
      
      const versionInfo = document.createElement('div');
      versionInfo.className = 'text-sm font-light sumi-text-light space-y-1';
      versionInfo.innerHTML = `
        <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0</p>
        <p>ãƒ“ãƒ«ãƒ‰ã‚¿ã‚°: PHASE-5-20240529</p>
        <p class="text-xs mt-2">é–‹ç™º: Manus AI</p>
      `;
      infoSection.appendChild(versionInfo);
      
      container.appendChild(infoSection);
    }
    
    function exportData() {
      try {
        const exportObj = {
          version: '1.0.0',
          exportDate: new Date().toISOString(),
          data: {
            history: state.history,
            day: state.day
          }
        };
        
        const jsonStr = JSON.stringify(exportObj, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().slice(0, 10);
        a.download = `muscle-routine-backup-${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼');
      } catch (e) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }
    
    function importData(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importObj = JSON.parse(e.target.result);
          
          if (!importObj.data || !importObj.data.history) {
            throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
          }
          
          const confirmed = confirm('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚');
          if (!confirmed) return;
          
          state.history = importObj.data.history || [];
          if (importObj.data.day) {
            state.day = importObj.data.day;
          }
          
          saveHistory();
          render();
          
          alert(`ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼\nå±¥æ­´: ${state.history.length}ä»¶`);
        } catch (e) {
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
      };
      reader.readAsText(file);
    }
    
    function showCustomDataManagement() {
      const modal = document.getElementById('customDataModal');
      if (!modal) {
        const newModal = document.createElement('div');
        newModal.id = 'customDataModal';
        newModal.className = 'fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50';
        newModal.style.display = 'none';
        newModal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-neutral-200/40 px-6 py-4 flex items-center justify-between">
              <h2 class="text-lg font-light sumi-text" style="letter-spacing: 0.05em;">ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
              <button type="button" class="text-2xl text-neutral-400 hover:text-neutral-600 transition min-h-[44px] min-w-[44px]" onclick="document.getElementById('customDataModal').style.display='none'">&times;</button>
            </div>
            <div id="customDataContent" class="p-6 space-y-6"></div>
          </div>
        `;
        document.body.appendChild(newModal);
      }
      
      renderCustomDataContent();
      document.getElementById('customDataModal').style.display = 'flex';
    }
    
    function renderCustomDataContent() {
      const content = document.getElementById('customDataContent');
      content.innerHTML = '';
      
      const categories = [
        { key: 'gear', label: 'å™¨å…·', icon: 'ğŸ‹ï¸' },
        { key: 'attachments', label: 'ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆ', icon: 'ğŸ”—' },
        { key: 'angles', label: 'è§’åº¦', icon: 'ğŸ“Š' },
        { key: 'positions', label: 'ãƒã‚¸ã‚·ãƒ§ãƒ³', icon: 'ğŸ§˜' }
      ];
      
      categories.forEach(category => {
        const items = state.customMaster[category.key] || [];
        
        const section = document.createElement('div');
        section.className = 'space-y-3';
        
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between gap-2';
        
        const headerLeft = document.createElement('div');
        headerLeft.className = 'flex items-center gap-2';
        headerLeft.innerHTML = `
          <span class="text-xl">${category.icon}</span>
          <h3 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">${category.label}</h3>
          <span class="text-xs font-light sumi-text-light">(${items.length}ä»¶)</span>
        `;
        header.appendChild(headerLeft);
        
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
        addBtn.style.cssText = 'background-color: rgba(139, 92, 246, 0.1); color: var(--color-purple); border-color: rgba(139, 92, 246, 0.3); letter-spacing: 0.05em;';
        addBtn.textContent = 'ï¼‹ è¿½åŠ ';
        addBtn.addEventListener('click', () => addCustomData(category.key, category.label));
        header.appendChild(addBtn);
        
        section.appendChild(header);
        
        if (items.length === 0) {
          const emptyMsg = document.createElement('p');
          emptyMsg.className = 'text-sm font-light sumi-text-light pl-8';
          emptyMsg.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“';
          section.appendChild(emptyMsg);
        } else {
          const list = document.createElement('div');
          list.className = 'space-y-2 pl-8';
          
          items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center justify-between gap-2 p-3 rounded-lg border border-neutral-200/40 bg-neutral-50/30';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-sm font-light sumi-text';
            nameSpan.textContent = item;
            itemDiv.appendChild(nameSpan);
            
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex gap-2';
            
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
            editBtn.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em;';
            editBtn.textContent = 'ç·¨é›†';
            editBtn.addEventListener('click', () => editCustomData(category.key, index, item));
            buttonGroup.appendChild(editBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
            deleteBtn.style.cssText = 'background-color: rgba(254, 226, 226, 0.5); color: #dc2626; border-color: rgba(220, 38, 38, 0.3); letter-spacing: 0.05em;';
            deleteBtn.textContent = 'å‰Šé™¤';
            deleteBtn.addEventListener('click', () => deleteCustomData(category.key, index, item));
            buttonGroup.appendChild(deleteBtn);
            
            itemDiv.appendChild(buttonGroup);
            list.appendChild(itemDiv);
          });
          
          section.appendChild(list);
        }
        
        content.appendChild(section);
      });
      
      // ç¨®ç›®ã¯éƒ¨ä½ã”ã¨ã«è¡¨ç¤º
      const exercisesSection = document.createElement('div');
      exercisesSection.className = 'space-y-3';
      
      const exercisesHeader = document.createElement('div');
      exercisesHeader.className = 'flex items-center gap-2';
      const totalExercises = Object.values(state.customMaster.exercises || {}).reduce((sum, arr) => sum + arr.length, 0);
      exercisesHeader.innerHTML = `
        <span class="text-xl">ğŸ‹ï¸â€â™‚ï¸</span>
        <h3 class="text-base font-light sumi-text" style="letter-spacing: 0.05em;">ç¨®ç›®</h3>
        <span class="text-xs font-light sumi-text-light">(${totalExercises}ä»¶)</span>
      `;
      exercisesSection.appendChild(exercisesHeader);
      
      if (totalExercises === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'text-sm font-light sumi-text-light pl-8';
        emptyMsg.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ç¨®ç›®ã¯ã‚ã‚Šã¾ã›ã‚“';
        exercisesSection.appendChild(emptyMsg);
      } else {
        const partsList = document.createElement('div');
        partsList.className = 'space-y-4 pl-8';
        
        state.master.parts.forEach(part => {
          const exercises = state.customMaster.exercises[part.id] || [];
          if (exercises.length === 0) return;
          
          const partDiv = document.createElement('div');
          partDiv.className = 'space-y-2';
          
          const partHeaderDiv = document.createElement('div');
          partHeaderDiv.className = 'flex items-center justify-between gap-2';
          
          const partHeader = document.createElement('h4');
          partHeader.className = 'text-sm font-light sumi-text';
          partHeader.style.letterSpacing = '0.05em';
          partHeader.textContent = `${part.label} (${exercises.length}ä»¶)`;
          partHeaderDiv.appendChild(partHeader);
          
          const addExerciseBtn = document.createElement('button');
          addExerciseBtn.type = 'button';
          addExerciseBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
          addExerciseBtn.style.cssText = 'background-color: rgba(139, 92, 246, 0.1); color: var(--color-purple); border-color: rgba(139, 92, 246, 0.3); letter-spacing: 0.05em;';
          addExerciseBtn.textContent = 'ï¼‹ è¿½åŠ ';
          addExerciseBtn.addEventListener('click', () => addCustomExercise(part.id, part.label));
          partHeaderDiv.appendChild(addExerciseBtn);
          
          partDiv.appendChild(partHeaderDiv);
          
          const exercisesList = document.createElement('div');
          exercisesList.className = 'space-y-2';
          
          exercises.forEach((exercise, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center justify-between gap-2 p-3 rounded-lg border border-neutral-200/40 bg-neutral-50/30';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-sm font-light sumi-text';
            nameSpan.textContent = exercise;
            itemDiv.appendChild(nameSpan);
            
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex gap-2';
            
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
            editBtn.style.cssText = 'background-color: rgba(245, 237, 214, 0.2); color: var(--color-gold); border-color: rgba(212, 175, 55, 0.3); letter-spacing: 0.05em;';
            editBtn.textContent = 'ç·¨é›†';
            editBtn.addEventListener('click', () => editCustomExercise(part.id, index, exercise));
            buttonGroup.appendChild(editBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'px-3 py-1.5 rounded-full text-xs font-light min-h-[36px] border transition';
            deleteBtn.style.cssText = 'background-color: rgba(254, 226, 226, 0.5); color: #dc2626; border-color: rgba(220, 38, 38, 0.3); letter-spacing: 0.05em;';
            deleteBtn.textContent = 'å‰Šé™¤';
            deleteBtn.addEventListener('click', () => deleteCustomExercise(part.id, index, exercise));
            buttonGroup.appendChild(deleteBtn);
            
            itemDiv.appendChild(buttonGroup);
            exercisesList.appendChild(itemDiv);
          });
          
          partDiv.appendChild(exercisesList);
          partsList.appendChild(partDiv);
        });
        
        exercisesSection.appendChild(partsList);
      }
      
      content.appendChild(exercisesSection);
    }
    
    function editCustomData(categoryKey, index, currentName) {
      const newName = prompt(`æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, currentName);
      if (!newName || newName.trim() === '') return;
      if (newName === currentName) return;
      
      state.customMaster[categoryKey][index] = newName.trim();
      saveCustomMasterData();
      renderCustomDataContent();
    }
    
    function deleteCustomData(categoryKey, index, name) {
      const confirmed = confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!confirmed) return;
      
      state.customMaster[categoryKey].splice(index, 1);
      saveCustomMasterData();
      renderCustomDataContent();
    }
    
    function editCustomExercise(partId, index, currentName) {
      const newName = prompt(`æ–°ã—ã„ç¨®ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, currentName);
      if (!newName || newName.trim() === '') return;
      if (newName === currentName) return;
      
      state.customMaster.exercises[partId][index] = newName.trim();
      saveCustomMasterData();
      renderCustomDataContent();
    }
    
    function deleteCustomExercise(partId, index, name) {
      const confirmed = confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!confirmed) return;
      
      state.customMaster.exercises[partId].splice(index, 1);
      saveCustomMasterData();
      renderCustomDataContent();
    }
    
    function addCustomData(categoryKey, categoryLabel) {
      const newName = prompt(`æ–°ã—ã„${categoryLabel}ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
      if (!newName || newName.trim() === '') return;
      
      if (!state.customMaster[categoryKey]) {
        state.customMaster[categoryKey] = [];
      }
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (state.customMaster[categoryKey].includes(newName.trim())) {
        alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
        return;
      }
      
      state.customMaster[categoryKey].push(newName.trim());
      saveCustomMasterData();
      renderCustomDataContent();
    }
    
    function addCustomExercise(partId, partLabel) {
      const newName = prompt(`${partLabel}ã®æ–°ã—ã„ç¨®ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
      if (!newName || newName.trim() === '') return;
      
      if (!state.customMaster.exercises[partId]) {
        state.customMaster.exercises[partId] = [];
      }
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (state.customMaster.exercises[partId].includes(newName.trim())) {
        alert('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
        return;
      }
      
      state.customMaster.exercises[partId].push(newName.trim());
      saveCustomMasterData();
      renderCustomDataContent();
    }
    
    function clearAllData() {
      const confirmed = confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚');
      if (!confirmed) return;
      
      const doubleConfirmed = confirm('æœ€çµ‚ç¢ºèª: æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');
      if (!doubleConfirmed) return;
      
      try {
        localStorage.clear();
        state.history = [];
        state.day = {
          date: new Date().toISOString().slice(0, 10),
          memo: '',
          items: []
        };
        render();
        alert('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        navigate('#/dashboard');
      } catch (e) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
    let autoSaveTimeout = null;

    function autoSaveDraft() {
      // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
      
      autoSaveTimeout = setTimeout(() => {
        try {
          // activeEditSession ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€å¤‰æ›´ã‚’state.day.itemsã«åæ˜ 
          if (activeEditSession && activeEditSession.itemId) {
            const item = state.day.items.find(it => it.id === activeEditSession.itemId);
            if (!item) {
              console.warn('Item not found for auto-save');
              return;
            }
            item.sets = activeEditSession.rows.flatMap(row => {
              const sets = [{
                id: row.id,
                weight: row.weight,
                repsU: row.repsU,
                repsA: row.repsA,
                seconds: row.seconds,
                warmup: row.warmup,
                round: row.round,
                memo: row.memo,
                drop: false,
                ts: Date.now()
              }];
              row.drops.forEach(drop => {
                sets.push({
                  id: drop.id,
                  weight: drop.weight,
                  repsU: drop.repsU,
                  repsA: drop.repsA,
                  seconds: drop.seconds,
                  warmup: drop.warmup,
                  round: drop.round,
                  drop: true,
                  ts: Date.now()
                });
              });
              return sets;
            });
          }
          
          const draft = {
            date: state.day.date,
            items: state.day.items,
            memo: state.day.memo,
            timestamp: Date.now()
          };
          localStorage.setItem('draft_day', JSON.stringify(draft));
          console.log('Draft auto-saved at', new Date().toLocaleTimeString());
        } catch (e) {
          console.error('Failed to auto-save draft:', e);
        }
      }, 300);
    }

    function restoreDraft() {
      try {
        const draftStr = localStorage.getItem('draft_day');
        if (!draftStr) return false;
        
        const draft = JSON.parse(draftStr);
        const today = new Date().toISOString().slice(0, 10);
        
        // æ—¥ä»˜ãŒä¸€è‡´ã™ã‚‹å ´åˆã®ã¿å¾©å…ƒ
        if (draft.date === today) {
          state.day = {
            date: draft.date,
            items: draft.items,
            memo: draft.memo
          };
          console.log('Draft restored from', new Date(draft.timestamp).toLocaleString());
          return true;
        } else {
          // å¤ã„ä¸‹æ›¸ãã‚’å‰Šé™¤
          localStorage.removeItem('draft_day');
          return false;
        }
      } catch (e) {
        console.error('Failed to restore draft:', e);
        return false;
      }
    }

    function clearDraft() {
      try {
        localStorage.removeItem('draft_day');
        console.log('Draft cleared');
      } catch (e) {
        console.error('Failed to clear draft:', e);
      }
    }

    // ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
    function loadCustomMaster() {
      try {
        const stored = localStorage.getItem('customMaster');
        if (stored) {
          const custom = JSON.parse(stored);
          state.customMaster = {
            exercises: custom.exercises || {},
            gear: custom.gear || [],
            attachments: custom.attachments || [],
            angles: custom.angles || [],
            positions: custom.positions || []
          };
          console.log('Custom master data loaded');
        }
      } catch (e) {
        console.error('Failed to load custom master data:', e);
      }
    }

    function saveCustomMaster() {
      try {
        localStorage.setItem('customMaster', JSON.stringify(state.customMaster));
        console.log('Custom master data saved');
      } catch (e) {
        console.error('Failed to save custom master data:', e);
      }
    }

    // ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨çµ±åˆï¼‰
    function getAllExercises(part) {
      const defaults = state.master.exercises[part] || [];
      const custom = state.customMaster.exercises[part] || [];
      return [...custom, ...defaults];
    }

    function getAllGear() {
      const defaults = state.master.gear;
      const custom = state.customMaster.gear;
      return [...custom, ...defaults];
    }

    function getAllAttachments() {
      const defaults = state.master.attachments;
      const custom = state.customMaster.attachments;
      return [...custom, ...defaults];
    }

    function getAllAngles() {
      const defaults = state.master.angles;
      const custom = state.customMaster.angles;
      return [...custom, ...defaults];
    }

    function getAllPositions() {
      const defaults = state.master.positions;
      const custom = state.customMaster.positions;
      return [...custom, ...defaults];
    }

    // ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
    function addCustomExercise(part, name) {
      if (!state.customMaster.exercises[part]) {
        state.customMaster.exercises[part] = [];
      }
      const allExercises = getAllExercises(part);
      if (allExercises.includes(name)) {
        alert('ã“ã®ç¨®ç›®ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
        return false;
      }
      state.customMaster.exercises[part].push(name);
      saveCustomMaster();
      return true;
    }

    function addCustomGear(name) {
      const allGear = getAllGear();
      if (allGear.includes(name)) {
        alert('ã“ã®å™¨å…·ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
        return false;
      }
      state.customMaster.gear.push(name);
      saveCustomMaster();
      return true;
    }

    function addCustomAttachment(name) {
      const allAttachments = getAllAttachments();
      if (allAttachments.includes(name)) {
        alert('ã“ã®ã‚¢ã‚¿ãƒƒãƒãƒ¡ãƒ³ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
        return false;
      }
      state.customMaster.attachments.push(name);
      saveCustomMaster();
      return true;
    }

    function addCustomAngle(name) {
      const allAngles = getAllAngles();
      if (allAngles.includes(name)) {
        alert('ã“ã®è§’åº¦ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
        return false;
      }
      state.customMaster.angles.push(name);
      saveCustomMaster();
      return true;
    }

    function addCustomPosition(name) {
      const allPositions = getAllPositions();
      if (allPositions.includes(name)) {
        alert('ã“ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
        return false;
      }
      state.customMaster.positions.push(name);
      saveCustomMaster();
      return true;
    }

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
    function showCustomModal(title, placeholder, callback) {
      const modal = document.getElementById('customModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalInput = document.getElementById('modalInput');
      const modalError = document.getElementById('modalError');
      
      modalTitle.textContent = title;
      modalInput.placeholder = placeholder;
      modalInput.value = '';
      modalError.textContent = '';
      modalError.classList.add('hidden');
      
      modal.classList.remove('hidden');
      modalInput.focus();
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      document.getElementById('modalCancel').onclick = () => {
        modal.classList.add('hidden');
        callback(null);
      };
      
      // è¿½åŠ ãƒœã‚¿ãƒ³
      document.getElementById('modalAdd').onclick = () => {
        const value = modalInput.value.trim();
        if (!value) {
          modalError.textContent = 'å…¥åŠ›ã—ã¦ãã ã•ã„';
          modalError.classList.remove('hidden');
          return;
        }
        modal.classList.add('hidden');
        callback(value);
      };
      
      // Enterã‚­ãƒ¼ã§è¿½åŠ 
      modalInput.onkeydown = (e) => {
        if (e.key === 'Enter') {
          document.getElementById('modalAdd').click();
        } else if (e.key === 'Escape') {
          document.getElementById('modalCancel').click();
        }
      };
    }

    function initialize() {
      loadHistory();
      loadCustomMaster(); // ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      restoreDraft(); // ä¸‹æ›¸ãã‚’å¾©å…ƒ
      handleNavigation(window.location.hash || '#/dashboard');
    }

    initialize();
  </script>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 m-4 max-w-sm w-full shadow-2xl">
      <h3 id="modalTitle" class="text-lg font-bold mb-4"></h3>
      <input id="modalInput" type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-yellow-600 focus:outline-none text-lg mb-2">
      <p id="modalError" class="text-red-600 text-sm mb-4 hidden"></p>
      <div class="flex gap-3">
        <button id="modalCancel" class="flex-1 px-4 py-3 bg-gray-200 text-gray-800 rounded-xl font-semibold hover:bg-gray-300 transition">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button id="modalAdd" class="flex-1 px-4 py-3 bg-yellow-600 text-white rounded-xl font-semibold hover:bg-yellow-700 transition">
          è¿½åŠ 
        </button>
      </div>
    </div>
  </div>
</body>
</html>
